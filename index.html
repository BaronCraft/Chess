<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —à–∞—Ö–º–∞—Ç–Ω–∞—è –¥–æ—Å–∫–∞ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –§–ò–î–ï + Lichess API</title>
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
        }
        
        body {
            font-family: 'Segoe UI', 'Arial', sans-serif;
            background: #1a2a32;
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            width: 100%;
            background: #2d3f4b;
            border-radius: 24px;
            padding: 25px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        h1 {
            text-align: center;
            color: #e8edf0;
            margin: 0 0 25px 0;
            font-weight: 400;
            font-size: 2.2em;
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        h1 span {
            color: #ffd966;
            font-weight: 600;
        }
        
        .main-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
        }
        
        .board-section {
            flex: 2;
            min-width: 550px;
        }
        
        .info-section {
            flex: 1;
            min-width: 320px;
            background: #28363f;
            border-radius: 20px;
            padding: 20px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);
            border: 1px solid #3f5562;
        }
        
        /* –®–∞—Ö–º–∞—Ç–Ω–∞—è –¥–æ—Å–∫–∞ */
        .board-container {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            border: 3px solid #c9a76b;
        }
        
        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            aspect-ratio: 1;
            background: #deb887;
        }
        
        .square {
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3.2em;
            cursor: pointer;
            transition: background 0.15s;
            position: relative;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        }
        
        .square.light {
            background-color: #f0d9b5;
        }
        
        .square.dark {
            background-color: #b58863;
        }
        
        .square.selected {
            background-color: #b6d7a8 !important;
            box-shadow: inset 0 0 0 3px #2e7d32;
        }
        
        .square.checked {
            background-color: #f4a7a7 !important;
            box-shadow: inset 0 0 0 3px #c62828;
        }
        
        .square.legal-move::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: rgba(0, 100, 0, 0.35);
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .square.legal-capture::after {
            content: '';
            position: absolute;
            width: 45px;
            height: 45px;
            border: 5px solid rgba(180, 0, 0, 0.4);
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .square.last-move-from {
            background-color: #ffecb3 !important;
        }
        
        .square.last-move-to {
            background-color: #ffe082 !important;
        }
        
        .coordinate {
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 11px;
            font-weight: bold;
            color: rgba(0,0,0,0.4);
            text-shadow: none;
        }
        
        .piece {
            filter: drop-shadow(2px 4px 4px rgba(0,0,0,0.4));
            transition: transform 0.1s;
        }
        
        .piece.white {
            color: #ffffff;
        }
        
        .piece.black {
            color: #222222;
        }
        
        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .status-panel {
            background: #1e2e38;
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 20px;
            border-left: 5px solid #ffd966;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        
        .turn-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            font-size: 1.3em;
            color: #e8edf0;
        }
        
        .turn-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ffd966;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            color: #1e2e38;
        }
        
        .check-warning {
            background: #c62828;
            color: white;
            padding: 8px 16px;
            border-radius: 30px;
            font-weight: bold;
            animation: pulse 1.5s infinite;
            text-align: center;
        }
        
        @keyframes pulse {
            0% { opacity: 0.9; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 0.9; transform: scale(1); }
        }
        
        /* –û—Ü–µ–Ω–∫–∞ */
        .evaluation-card {
            background: #1e2e38;
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 20px;
        }
        
        .eval-title {
            color: #ffd966;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 1.2em;
        }
        
        .eval-bar-container {
            height: 30px;
            background: linear-gradient(to right, #2c3e50, #ecf0f1);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid #4b6e7c;
            margin: 10px 0;
        }
        
        .eval-bar {
            height: 100%;
            width: 50%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.4s ease;
        }
        
        .eval-value {
            font-size: 2.2em;
            font-weight: bold;
            text-align: center;
            color: #ffd966;
            text-shadow: 2px 2px 0 #1a2a32;
        }
        
        .eval-details {
            color: #a0b8c5;
            font-size: 0.95em;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #3f5562;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        
        .btn {
            background: #3f5562;
            border: none;
            color: white;
            padding: 12px 18px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1 1 auto;
            font-size: 0.95em;
            border-bottom: 3px solid #1e2e38;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .btn:hover {
            background: #4f6b7c;
            transform: translateY(-2px);
            border-bottom-color: #ffd966;
        }
        
        .btn.primary {
            background: #ffd966;
            color: #1e2e38;
            border-bottom-color: #b68b40;
        }
        
        .btn.primary:hover {
            background: #ffe082;
        }
        
        .btn:active {
            transform: translateY(2px);
            border-bottom-width: 1px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* FEN –∏ –∏—Å—Ç–æ—Ä–∏—è */
        .fen-box {
            background: #1a2a32;
            padding: 12px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #a0b8c5;
            word-break: break-all;
            border: 1px solid #3f5562;
            margin: 15px 0;
        }
        
        .history-container {
            max-height: 250px;
            overflow-y: auto;
            background: #1a2a32;
            border-radius: 12px;
            padding: 12px;
            border: 1px solid #3f5562;
        }
        
        .move-list {
            display: grid;
            grid-template-columns: 35px 1fr 1fr;
            gap: 6px;
            font-size: 0.95em;
        }
        
        .move-number {
            color: #ffd966;
            font-weight: bold;
        }
        
        .white-move, .black-move {
            color: #e8edf0;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            background: #28363f;
            text-align: center;
        }
        
        .white-move:hover, .black-move:hover {
            background: #3f5562;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã */
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 4px solid #ffd966;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #c62828;
            color: white;
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>‚ôú <span>–ü—Ä–∞–≤–∏–ª–∞ –§–ò–î–ï</span> + –ê–Ω–∞–ª–∏–∑ Lichess ‚ôû</h1>
    
    <div class="main-panel">
        <div class="board-section">
            <div class="board-container">
                <div class="board" id="chessboard"></div>
            </div>
            
            <div class="button-group">
                <button class="btn" id="newGameBtn">‚ôî –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
                <button class="btn" id="flipBoardBtn">üîÑ –ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å –¥–æ—Å–∫—É</button>
                <button class="btn" id="undoBtn">‚Ü© –û—Ç–º–µ–Ω–∏—Ç—å —Ö–æ–¥</button>
                <button class="btn primary" id="analyzeBtn">üîç –ê–Ω–∞–ª–∏–∑ Lichess</button>
            </div>
        </div>
        
        <div class="info-section">
            <div class="status-panel">
                <div class="turn-indicator">
                    <div class="turn-icon" id="turnIcon">‚ö™</div>
                    <div id="turnText">–•–æ–¥ –±–µ–ª—ã—Ö</div>
                </div>
                <div id="checkDisplay" style="display: none;" class="check-warning">
                    ‚ö†Ô∏è –®–ê–• –ö–û–†–û–õ–Æ ‚ö†Ô∏è
                </div>
            </div>
            
            <div class="evaluation-card">
                <div class="eval-title">üìä –û—Ü–µ–Ω–∫–∞ Lichess Cloud</div>
                <div class="eval-bar-container">
                    <div class="eval-bar" id="evalBar" style="width: 50%"></div>
                </div>
                <div class="eval-value" id="evalValue">0.0</div>
                <div class="eval-details" id="evalDetails">
                    –ì–ª—É–±–∏–Ω–∞: ‚Äî<br>
                    –õ—É—á—à–∏–π —Ö–æ–¥: ‚Äî
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <span id="apiStatus"></span>
                </div>
            </div>
            
            <div class="fen-box" id="fenDisplay">rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1</div>
            
            <div style="margin-bottom: 10px; color: #ffd966;">üìú –ò—Å—Ç–æ—Ä–∏—è —Ö–æ–¥–æ–≤:</div>
            <div class="history-container">
                <div id="moveHistory" class="move-list"></div>
            </div>
            
            <div id="errorDisplay" class="error-message" style="display: none;"></div>
            <div id="loadingDisplay" style="display: none; justify-content: center; margin: 15px 0;">
                <div class="loading"></div>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        // ---------- –ü–û–õ–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ê–í–ò–õ –§–ò–î–ï ----------
        const pieceSymbols = {
            'K': '‚ôî', 'Q': '‚ôï', 'R': '‚ôñ', 'B': '‚ôó', 'N': '‚ôò', 'P': '‚ôô',
            'k': '‚ôö', 'q': '‚ôõ', 'r': '‚ôú', 'b': '‚ôù', 'n': '‚ôû', 'p': '‚ôü'
        };
        
        class ChessGame {
            constructor() {
                this.board = Array(8).fill().map(() => Array(8).fill(''));
                this.currentPlayer = 'w'; // 'w' –∏–ª–∏ 'b'
                this.castling = { w: { K: true, Q: true }, b: { K: true, Q: true } };
                this.enPassantTarget = null; // { row, col } –ø–æ–ª–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–Ω–æ –≤–∑—è—Ç—å –Ω–∞ –ø—Ä–æ—Ö–æ–¥–µ
                this.halfMoveClock = 0;
                this.fullMoveNumber = 1;
                this.moveHistory = [];
                this.positionHistory = []; // –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π
                this.lastMove = null;
                this.kingPositions = { w: { row: 7, col: 4 }, b: { row: 0, col: 4 } };
                
                this.initBoard();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—á–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
            initBoard() {
                // –û—á–∏—Å—Ç–∫–∞
                this.board = Array(8).fill().map(() => Array(8).fill(''));
                
                // –ü–µ—à–∫–∏
                for (let col = 0; col < 8; col++) {
                    this.board[6][col] = 'P'; // –±–µ–ª—ã–µ –ø–µ—à–∫–∏ (—Ä—è–¥ 6)
                    this.board[1][col] = 'p'; // —á–µ—Ä–Ω—ã–µ –ø–µ—à–∫–∏ (—Ä—è–¥ 1)
                }
                
                // –õ–∞–¥—å–∏
                this.board[7][0] = 'R'; this.board[7][7] = 'R';
                this.board[0][0] = 'r'; this.board[0][7] = 'r';
                
                // –ö–æ–Ω–∏
                this.board[7][1] = 'N'; this.board[7][6] = 'N';
                this.board[0][1] = 'n'; this.board[0][6] = 'n';
                
                // –°–ª–æ–Ω—ã
                this.board[7][2] = 'B'; this.board[7][5] = 'B';
                this.board[0][2] = 'b'; this.board[0][5] = 'b';
                
                // –§–µ—Ä–∑–∏
                this.board[7][3] = 'Q';
                this.board[0][3] = 'q';
                
                // –ö–æ—Ä–æ–ª–∏
                this.board[7][4] = 'K';
                this.board[0][4] = 'k';
                
                this.kingPositions = { w: { row: 7, col: 4 }, b: { row: 0, col: 4 } };
                this.currentPlayer = 'w';
                this.castling = { w: { K: true, Q: true }, b: { K: true, Q: true } };
                this.enPassantTarget = null;
                this.halfMoveClock = 0;
                this.fullMoveNumber = 1;
                this.moveHistory = [];
                this.positionHistory = [this.getFENWithoutCounters()];
                this.lastMove = null;
            }
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ FEN
            getFEN() {
                let fen = '';
                for (let r = 0; r < 8; r++) {
                    let empty = 0;
                    for (let c = 0; c < 8; c++) {
                        if (this.board[r][c] === '') {
                            empty++;
                        } else {
                            if (empty > 0) {
                                fen += empty;
                                empty = 0;
                            }
                            fen += this.board[r][c];
                        }
                    }
                    if (empty > 0) fen += empty;
                    if (r < 7) fen += '/';
                }
                
                // –û—á–µ—Ä–µ–¥—å —Ö–æ–¥–∞
                fen += this.currentPlayer === 'w' ? ' w ' : ' b ';
                
                // –†–æ–∫–∏—Ä–æ–≤–∫–∞
                let castlingStr = '';
                if (this.castling.w.K) castlingStr += 'K';
                if (this.castling.w.Q) castlingStr += 'Q';
                if (this.castling.b.K) castlingStr += 'k';
                if (this.castling.b.Q) castlingStr += 'q';
                fen += castlingStr || '-';
                
                // –í–∑—è—Ç–∏–µ –Ω–∞ –ø—Ä–æ—Ö–æ–¥–µ
                if (this.enPassantTarget) {
                    const colChar = String.fromCharCode(97 + this.enPassantTarget.col);
                    const rowNum = 8 - this.enPassantTarget.row;
                    fen += ` ${colChar}${rowNum}`;
                } else {
                    fen += ' -';
                }
                
                // –ü–æ–ª—É—Ö–æ–¥—ã –∏ –Ω–æ–º–µ—Ä —Ö–æ–¥–∞
                fen += ` ${this.halfMoveClock} ${this.fullMoveNumber}`;
                return fen;
            }
            
            getFENWithoutCounters() {
                return this.getFEN().split(' ').slice(0, 4).join(' ');
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –ø–æ–ª—è –ø–æ–¥ –∞—Ç–∞–∫–æ–π
            isSquareAttacked(row, col, attackerColor) {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ç–∞–∫ –ø–µ—à–µ–∫
                const pawnDir = attackerColor === 'w' ? 1 : -1;
                if (attackerColor === 'w') {
                    if (row+1 < 8 && col-1 >= 0 && this.board[row+1][col-1] === 'P') return true;
                    if (row+1 < 8 && col+1 < 8 && this.board[row+1][col+1] === 'P') return true;
                } else {
                    if (row-1 >= 0 && col-1 >= 0 && this.board[row-1][col-1] === 'p') return true;
                    if (row-1 >= 0 && col+1 < 8 && this.board[row-1][col+1] === 'p') return true;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ç–∞–∫ –∫–æ–Ω–µ–π
                const knightMoves = [[-2,-1], [-2,1], [-1,-2], [-1,2], [1,-2], [1,2], [2,-1], [2,1]];
                for (let [dr, dc] of knightMoves) {
                    const r = row + dr, c = col + dc;
                    if (r >= 0 && r < 8 && c >= 0 && c < 8) {
                        const piece = this.board[r][c];
                        if (piece && piece.toLowerCase() === 'n' && 
                            ((attackerColor === 'w' && piece === 'N') || (attackerColor === 'b' && piece === 'n'))) {
                            return true;
                        }
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ç–∞–∫ –ø–æ –ø—Ä—è–º—ã–º –∏ –¥–∏–∞–≥–æ–Ω–∞–ª—è–º (–ª–∞–¥—å—è, —Å–ª–æ–Ω, —Ñ–µ—Ä–∑—å)
                const directions = [
                    [-1,0], [1,0], [0,-1], [0,1], // –≤–µ—Ä—Ç–∏–∫–∞–ª—å/–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å
                    [-1,-1], [-1,1], [1,-1], [1,1] // –¥–∏–∞–≥–æ–Ω–∞–ª–∏
                ];
                
                for (let [dr, dc] of directions) {
                    for (let step = 1; step < 8; step++) {
                        const r = row + dr * step;
                        const c = col + dc * step;
                        if (r < 0 || r >= 8 || c < 0 || c >= 8) break;
                        
                        const piece = this.board[r][c];
                        if (piece) {
                            const isWhitePiece = piece === piece.toUpperCase();
                            if ((attackerColor === 'w' && isWhitePiece) || (attackerColor === 'b' && !isWhitePiece)) {
                                const type = piece.toLowerCase();
                                // –õ–∞–¥—å—è –∏–ª–∏ —Ñ–µ—Ä–∑—å –¥–ª—è –ø—Ä—è–º—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
                                if ((dr === 0 || dc === 0) && (type === 'r' || type === 'q')) return true;
                                // –°–ª–æ–Ω –∏–ª–∏ —Ñ–µ—Ä–∑—å –¥–ª—è –¥–∏–∞–≥–æ–Ω–∞–ª–µ–π
                                if ((dr !== 0 && dc !== 0) && (type === 'b' || type === 'q')) return true;
                                break;
                            } else {
                                break; // –ù–∞—Ç–∫–Ω—É–ª–∏—Å—å –Ω–∞ —Å–≤–æ—é —Ñ–∏–≥—É—Ä—É
                            }
                        }
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ç–∞–∫ –∫–æ—Ä–æ–ª—è
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        if (dr === 0 && dc === 0) continue;
                        const r = row + dr, c = col + dc;
                        if (r >= 0 && r < 8 && c >= 0 && c < 8) {
                            const piece = this.board[r][c];
                            if (piece && piece.toLowerCase() === 'k') {
                                if ((attackerColor === 'w' && piece === 'K') || (attackerColor === 'b' && piece === 'k')) {
                                    return true;
                                }
                            }
                        }
                    }
                }
                
                return false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —à–∞—Ö–∞ –∫–æ—Ä–æ–ª—é —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
            isCheck(player = this.currentPlayer) {
                const kingPos = this.kingPositions[player];
                return this.isSquareAttacked(kingPos.row, kingPos.col, player === 'w' ? 'b' : 'w');
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ç–∞
            isCheckmate() {
                if (!this.isCheck()) return false;
                return this.generateAllMoves().length === 0;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ç–∞
            isStalemate() {
                if (this.isCheck()) return false;
                return this.generateAllMoves().length === 0;
            }
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –ª–µ–≥–∞–ª—å–Ω—ã—Ö —Ö–æ–¥–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
            generateAllMoves() {
                const moves = [];
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        const piece = this.board[r][c];
                        if (piece && ((this.currentPlayer === 'w' && piece === piece.toUpperCase()) ||
                                     (this.currentPlayer === 'b' && piece === piece.toLowerCase()))) {
                            const pieceMoves = this.generatePieceMoves(r, c);
                            moves.push(...pieceMoves);
                        }
                    }
                }
                return moves;
            }
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ö–æ–¥–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ñ–∏–≥—É—Ä—ã
            generatePieceMoves(row, col) {
                const piece = this.board[row][col];
                if (!piece) return [];
                
                const isWhite = piece === piece.toUpperCase();
                const pieceType = piece.toLowerCase();
                const moves = [];
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                switch (pieceType) {
                    case 'p': this.generatePawnMoves(row, col, isWhite, moves); break;
                    case 'n': this.generateKnightMoves(row, col, isWhite, moves); break;
                    case 'b': this.generateBishopMoves(row, col, isWhite, moves); break;
                    case 'r': this.generateRookMoves(row, col, isWhite, moves); break;
                    case 'q': this.generateQueenMoves(row, col, isWhite, moves); break;
                    case 'k': this.generateKingMoves(row, col, isWhite, moves); break;
                }
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ö–æ–¥—ã, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ —Ç–µ, –ø–æ—Å–ª–µ –∫–æ—Ç–æ—Ä—ã—Ö –∫–æ—Ä–æ–ª—å –Ω–µ –ø–æ–¥ —à–∞—Ö–æ–º
                return moves.filter(move => this.isMoveLegal({ from: { row, col }, to: move }));
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–µ–≥–∞–ª—å–Ω–æ—Å—Ç–∏ —Ö–æ–¥–∞ (–Ω–µ –æ—Å—Ç–∞–≤–ª—è–µ—Ç –ª–∏ –∫–æ—Ä–æ–ª—è –ø–æ–¥ —à–∞—Ö–æ–º)
            isMoveLegal(move) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const piece = this.board[move.from.row][move.from.col];
                const targetPiece = this.board[move.to.row][move.to.col];
                const oldCastling = JSON.parse(JSON.stringify(this.castling));
                const oldEnPassant = this.enPassantTarget;
                const oldKingPos = { ...this.kingPositions[this.currentPlayer] };
                
                // –í—Ä–µ–º–µ–Ω–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ–º —Ö–æ–¥
                this.board[move.to.row][move.to.col] = piece;
                this.board[move.from.row][move.from.col] = '';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–æ—Ä–æ–ª—è –µ—Å–ª–∏ —Ö–æ–¥–∏–ª–∏ –∫–æ—Ä–æ–ª–µ–º
                if (piece.toLowerCase() === 'k') {
                    this.kingPositions[this.currentPlayer] = { row: move.to.row, col: move.to.col };
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —à–∞—Ö
                const inCheck = this.isCheck(this.currentPlayer);
                
                // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º
                this.board[move.from.row][move.from.col] = piece;
                this.board[move.to.row][move.to.col] = targetPiece;
                this.kingPositions[this.currentPlayer] = oldKingPos;
                this.castling = oldCastling;
                this.enPassantTarget = oldEnPassant;
                
                return !inCheck;
            }
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ö–æ–¥–æ–≤ –ø–µ—à–∫–∏
            generatePawnMoves(row, col, isWhite, moves) {
                const direction = isWhite ? -1 : 1;
                const startRow = isWhite ? 6 : 1;
                
                // –î–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä–µ–¥ –Ω–∞ 1
                if (row + direction >= 0 && row + direction < 8 && this.board[row + direction][col] === '') {
                    this.addPawnMove(row, col, row + direction, col, isWhite, moves);
                    
                    // –î–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä–µ–¥ –Ω–∞ 2 —Å –Ω–∞—á–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
                    if (row === startRow && this.board[row + 2*direction][col] === '') {
                        this.addPawnMove(row, col, row + 2*direction, col, isWhite, moves);
                    }
                }
                
                // –í–∑—è—Ç–∏—è
                for (let dcol of [-1, 1]) {
                    const newCol = col + dcol;
                    if (newCol >= 0 && newCol < 8 && row + direction >= 0 && row + direction < 8) {
                        // –û–±—ã—á–Ω–æ–µ –≤–∑—è—Ç–∏–µ
                        const target = this.board[row + direction][newCol];
                        if (target && ((isWhite && target === target.toLowerCase()) || (!isWhite && target === target.toUpperCase()))) {
                            this.addPawnMove(row, col, row + direction, newCol, isWhite, moves);
                        }
                        
                        // –í–∑—è—Ç–∏–µ –Ω–∞ –ø—Ä–æ—Ö–æ–¥–µ
                        if (this.enPassantTarget && 
                            this.enPassantTarget.row === row + direction && 
                            this.enPassantTarget.col === newCol) {
                            moves.push({ row: row + direction, col: newCol, enPassant: true });
                        }
                    }
                }
            }
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ö–æ–¥–∞ –ø–µ—à–∫–∏ —Å —É—á–µ—Ç–æ–º –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—è
            addPawnMove(fromRow, fromCol, toRow, toCol, isWhite, moves) {
                const promotionRank = isWhite ? 0 : 7;
                if (toRow === promotionRank) {
                    // –ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ
                    ['q', 'r', 'b', 'n'].forEach(pieceType => {
                        moves.push({ row: toRow, col: toCol, promotion: pieceType });
                    });
                } else {
                    moves.push({ row: toRow, col: toCol });
                }
            }
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ö–æ–¥–æ–≤ –∫–æ–Ω—è
            generateKnightMoves(row, col, isWhite, moves) {
                const knightOffsets = [[-2,-1], [-2,1], [-1,-2], [-1,2], [1,-2], [1,2], [2,-1], [2,1]];
                
                for (let [dr, dc] of knightOffsets) {
                    const newRow = row + dr;
                    const newCol = col + dc;
                    if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
                        const target = this.board[newRow][newCol];
                        if (target === '' || 
                            (isWhite && target === target.toLowerCase()) || 
                            (!isWhite && target === target.toUpperCase())) {
                            moves.push({ row: newRow, col: newCol });
                        }
                    }
                }
            }
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ö–æ–¥–æ–≤ —Å–ª–æ–Ω–∞
            generateBishopMoves(row, col, isWhite, moves) {
                const directions = [[-1,-1], [-1,1], [1,-1], [1,1]];
                this.generateSlidingMoves(row, col, isWhite, directions, moves);
            }
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ö–æ–¥–æ–≤ –ª–∞–¥—å–∏
            generateRookMoves(row, col, isWhite, moves) {
                const directions = [[-1,0], [1,0], [0,-1], [0,1]];
                this.generateSlidingMoves(row, col, isWhite, directions, moves);
            }
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ö–æ–¥–æ–≤ —Ñ–µ—Ä–∑—è
            generateQueenMoves(row, col, isWhite, moves) {
                const directions = [[-1,0], [1,0], [0,-1], [0,1], [-1,-1], [-1,1], [1,-1], [1,1]];
                this.generateSlidingMoves(row, col, isWhite, directions, moves);
            }
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∫–æ–ª—å–∑—è—â–∏—Ö —Ö–æ–¥–æ–≤ (–ª–∞–¥—å—è, —Å–ª–æ–Ω, —Ñ–µ—Ä–∑—å)
            generateSlidingMoves(row, col, isWhite, directions, moves) {
                for (let [dr, dc] of directions) {
                    for (let step = 1; step < 8; step++) {
                        const newRow = row + dr * step;
                        const newCol = col + dc * step;
                        if (newRow < 0 || newRow >= 8 || newCol < 0 || newCol >= 8) break;
                        
                        const target = this.board[newRow][newCol];
                        if (target === '') {
                            moves.push({ row: newRow, col: newCol });
                        } else {
                            if ((isWhite && target === target.toLowerCase()) || (!isWhite && target === target.toUpperCase())) {
                                moves.push({ row: newRow, col: newCol });
                            }
                            break;
                        }
                    }
                }
            }
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ö–æ–¥–æ–≤ –∫–æ—Ä–æ–ª—è (–≤–∫–ª—é—á–∞—è —Ä–æ–∫–∏—Ä–æ–≤–∫—É)
            generateKingMoves(row, col, isWhite, moves) {
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        if (dr === 0 && dc === 0) continue;
                        const newRow = row + dr;
                        const newCol = col + dc;
                        if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
                            const target = this.board[newRow][newCol];
                            if (target === '' || 
                                (isWhite && target === target.toLowerCase()) || 
                                (!isWhite && target === target.toUpperCase())) {
                                moves.push({ row: newRow, col: newCol });
                            }
                        }
                    }
                }
                
                // –†–æ–∫–∏—Ä–æ–≤–∫–∞
                if (!this.isCheck()) {
                    const kingRow = isWhite ? 7 : 0;
                    const castlingRights = this.castling[isWhite ? 'w' : 'b'];
                    
                    // –ö–æ—Ä–æ—Ç–∫–∞—è —Ä–æ–∫–∏—Ä–æ–≤–∫–∞ (K)
                    if (castlingRights.K) {
                        const emptySquares = this.board[kingRow][5] === '' && this.board[kingRow][6] === '';
                        const notAttacked = !this.isSquareAttacked(kingRow, 5, isWhite ? 'b' : 'w') && 
                                           !this.isSquareAttacked(kingRow, 6, isWhite ? 'b' : 'w');
                        if (emptySquares && notAttacked && this.board[kingRow][7] !== '' && 
                            ((isWhite && this.board[kingRow][7] === 'R') || (!isWhite && this.board[kingRow][7] === 'r'))) {
                            moves.push({ row: kingRow, col: 6, castling: 'K' });
                        }
                    }
                    
                    // –î–ª–∏–Ω–Ω–∞—è —Ä–æ–∫–∏—Ä–æ–≤–∫–∞ (Q)
                    if (castlingRights.Q) {
                        const emptySquares = this.board[kingRow][1] === '' && this.board[kingRow][2] === '' && this.board[kingRow][3] === '';
                        const notAttacked = !this.isSquareAttacked(kingRow, 2, isWhite ? 'b' : 'w') && 
                                           !this.isSquareAttacked(kingRow, 3, isWhite ? 'b' : 'w');
                        if (emptySquares && notAttacked && this.board[kingRow][0] !== '' && 
                            ((isWhite && this.board[kingRow][0] === 'R') || (!isWhite && this.board[kingRow][0] === 'r'))) {
                            moves.push({ row: kingRow, col: 2, castling: 'Q' });
                        }
                    }
                }
            }
            
            // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ö–æ–¥–∞
            makeMove(from, to, promotion = null) {
                const piece = this.board[from.row][from.col];
                const isWhite = piece === piece.toUpperCase();
                const pieceType = piece.toLowerCase();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                const capturedPiece = this.board[to.row][to.col];
                const oldCastling = JSON.parse(JSON.stringify(this.castling));
                const oldEnPassant = this.enPassantTarget;
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤
                if (pieceType === 'p' || capturedPiece) {
                    this.halfMoveClock = 0;
                } else {
                    this.halfMoveClock++;
                }
                
                if (this.currentPlayer === 'b') {
                    this.fullMoveNumber++;
                }
                
                // –°–±—Ä–æ—Å –≤–∑—è—Ç–∏—è –Ω–∞ –ø—Ä–æ—Ö–æ–¥–µ
                this.enPassantTarget = null;
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ö–æ–¥–æ–≤
                if (pieceType === 'p') {
                    // –í–∑—è—Ç–∏–µ –Ω–∞ –ø—Ä–æ—Ö–æ–¥–µ
                    if (to.enPassant) {
                        this.board[from.row][to.col] = ''; // —É–±–∏—Ä–∞–µ–º –ø–µ—à–∫—É, –∫–æ—Ç–æ—Ä—É—é –≤–∑—è–ª–∏
                    }
                    
                    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∑—è—Ç–∏—è –Ω–∞ –ø—Ä–æ—Ö–æ–¥–µ –¥–ª—è –¥–≤–æ–π–Ω–æ–≥–æ —Ö–æ–¥–∞ –ø–µ—à–∫–∏
                    if (Math.abs(to.row - from.row) === 2) {
                        this.enPassantTarget = { row: (from.row + to.row) / 2, col: from.col };
                    }
                    
                    // –ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—à–∫–∏
                    if (to.row === 0 || to.row === 7) {
                        const promotionPiece = promotion ? (isWhite ? promotion.toUpperCase() : promotion.toLowerCase()) : (isWhite ? 'Q' : 'q');
                        this.board[to.row][to.col] = promotionPiece;
                        this.board[from.row][from.col] = '';
                    } else {
                        // –û–±—ã—á–Ω—ã–π —Ö–æ–¥ –ø–µ—à–∫–∏
                        this.board[to.row][to.col] = piece;
                        this.board[from.row][from.col] = '';
                    }
                } else if (pieceType === 'k') {
                    // –†–æ–∫–∏—Ä–æ–≤–∫–∞
                    if (to.castling) {
                        if (to.col === 6) { // –ö–æ—Ä–æ—Ç–∫–∞—è
                            this.board[to.row][5] = this.board[to.row][7];
                            this.board[to.row][7] = '';
                        } else if (to.col === 2) { // –î–ª–∏–Ω–Ω–∞—è
                            this.board[to.row][3] = this.board[to.row][0];
                            this.board[to.row][0] = '';
                        }
                    }
                    
                    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–æ—Ä–æ–ª—è
                    this.board[to.row][to.col] = piece;
                    this.board[from.row][from.col] = '';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–æ–∫–∏—Ä–æ–≤–∫—É
                    if (isWhite) {
                        this.castling.w.K = false;
                        this.castling.w.Q = false;
                    } else {
                        this.castling.b.K = false;
                        this.castling.b.Q = false;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–æ—Ä–æ–ª—è
                    this.kingPositions[this.currentPlayer] = { row: to.row, col: to.col };
                } else {
                    // –û–±—ã—á–Ω—ã–π —Ö–æ–¥
                    this.board[to.row][to.col] = piece;
                    this.board[from.row][from.col] = '';
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –Ω–∞ —Ä–æ–∫–∏—Ä–æ–≤–∫—É –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –ª–∞–¥—å–∏
                if (pieceType === 'r') {
                    if (isWhite) {
                        if (from.row === 7 && from.col === 0) this.castling.w.Q = false;
                        if (from.row === 7 && from.col === 7) this.castling.w.K = false;
                    } else {
                        if (from.row === 0 && from.col === 0) this.castling.b.Q = false;
                        if (from.row === 0 && from.col === 7) this.castling.b.K = false;
                    }
                }
                
                // –ï—Å–ª–∏ –≤–∑—è–ª–∏ –ª–∞–¥—å—é, —Ç–æ–∂–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∞–≤–∞
                if (capturedPiece && capturedPiece.toLowerCase() === 'r') {
                    if (to.row === 7 && to.col === 0) this.castling.w.Q = false;
                    if (to.row === 7 && to.col === 7) this.castling.w.K = false;
                    if (to.row === 0 && to.col === 0) this.castling.b.Q = false;
                    if (to.row === 0 && to.col === 7) this.castling.b.K = false;
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ö–æ–¥ –≤ –∏—Å—Ç–æ—Ä–∏—é
                const moveNotation = this.formatMoveNotation(from, to, piece, capturedPiece, promotion);
                this.moveHistory.push({
                    from: { ...from },
                    to: { ...to },
                    piece,
                    captured: capturedPiece,
                    notation: moveNotation,
                    fen: this.getFEN()
                });
                
                // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –ø–æ–≤—Ç–æ—Ä–æ–≤
                this.positionHistory.push(this.getFENWithoutCounters());
                
                // –ú–µ–Ω—è–µ–º –∏–≥—Ä–æ–∫–∞
                this.currentPlayer = this.currentPlayer === 'w' ? 'b' : 'w';
                this.lastMove = { from, to };
                
                return true;
            }
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ—Ç–∞—Ü–∏–∏
            formatMoveNotation(from, to, piece, captured, promotion) {
                const pieceType = piece.toLowerCase();
                const isWhite = piece === piece.toUpperCase();
                let notation = '';
                
                if (pieceType === 'p') {
                    if (captured || to.enPassant) {
                        notation += String.fromCharCode(97 + from.col);
                        notation += 'x';
                    }
                    notation += String.fromCharCode(97 + to.col) + (8 - to.row);
                    if (promotion) {
                        notation += '=' + promotion.toUpperCase();
                    }
                } else {
                    const symbols = { 'k': 'K', 'q': 'Q', 'r': 'R', 'b': 'B', 'n': 'N' };
                    notation += symbols[pieceType];
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                    if (captured) notation += 'x';
                    notation += String.fromCharCode(97 + to.col) + (8 - to.row);
                    
                    if (to.castling) {
                        notation = to.col === 6 ? 'O-O' : 'O-O-O';
                    }
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º —à–∞—Ö/–º–∞—Ç
                const newGame = new ChessGame();
                newGame.board = this.board.map(row => [...row]);
                newGame.currentPlayer = this.currentPlayer === 'w' ? 'b' : 'w';
                newGame.kingPositions = JSON.parse(JSON.stringify(this.kingPositions));
                newGame.castling = JSON.parse(JSON.stringify(this.castling));
                
                if (newGame.isCheckmate()) {
                    notation += '#';
                } else if (newGame.isCheck()) {
                    notation += '+';
                }
                
                return notation;
            }
            
            // –û—Ç–º–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ö–æ–¥–∞
            undoMove() {
                if (this.moveHistory.length === 0) return false;
                
                // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –∏–∑ FEN –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
                const lastMove = this.moveHistory[this.moveHistory.length - 1];
                this.moveHistory.pop();
                this.positionHistory.pop();
                
                if (this.moveHistory.length > 0) {
                    const prevFEN = this.moveHistory[this.moveHistory.length - 1].fen;
                    this.loadFromFEN(prevFEN);
                } else {
                    this.initBoard();
                }
                
                this.lastMove = this.moveHistory.length > 0 ? this.moveHistory[this.moveHistory.length - 1] : null;
                return true;
            }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ FEN (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
            loadFromFEN(fen) {
                const parts = fen.split(' ');
                const position = parts[0];
                this.currentPlayer = parts[1];
                const castling = parts[2];
                const enPassant = parts[3];
                
                // –û—á–∏—Å—Ç–∫–∞ –¥–æ—Å–∫–∏
                this.board = Array(8).fill().map(() => Array(8).fill(''));
                
                // –†–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–∏–≥—É—Ä
                const rows = position.split('/');
                for (let r = 0; r < 8; r++) {
                    let col = 0;
                    for (let char of rows[r]) {
                        if (isNaN(char)) {
                            this.board[r][col] = char;
                            if (char.toLowerCase() === 'k') {
                                this.kingPositions[char === 'K' ? 'w' : 'b'] = { row: r, col };
                            }
                            col++;
                        } else {
                            col += parseInt(char);
                        }
                    }
                }
                
                // –†–æ–∫–∏—Ä–æ–≤–∫–∞
                this.castling = { w: { K: false, Q: false }, b: { K: false, Q: false } };
                if (castling.includes('K')) this.castling.w.K = true;
                if (castling.includes('Q')) this.castling.w.Q = true;
                if (castling.includes('k')) this.castling.b.K = true;
                if (castling.includes('q')) this.castling.b.Q = true;
                
                // –í–∑—è—Ç–∏–µ –Ω–∞ –ø—Ä–æ—Ö–æ–¥–µ
                if (enPassant !== '-') {
                    const col = enPassant.charCodeAt(0) - 97;
                    const row = 8 - parseInt(enPassant[1]);
                    this.enPassantTarget = { row, col };
                } else {
                    this.enPassantTarget = null;
                }
            }
        }
        
        // ---------- –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° LICHESS API ----------
        class ChessUI {
            constructor() {
                this.game = new ChessGame();
                this.flipped = false;
                this.selectedSquare = null;
                this.legalMoves = [];
                this.pendingPromotion = null; // { from, to }
                
                this.boardElement = document.getElementById('chessboard');
                this.fenDisplay = document.getElementById('fenDisplay');
                this.moveHistoryElement = document.getElementById('moveHistory');
                this.turnIcon = document.getElementById('turnIcon');
                this.turnText = document.getElementById('turnText');
                this.checkDisplay = document.getElementById('checkDisplay');
                this.errorDisplay = document.getElementById('errorDisplay');
                this.loadingDisplay = document.getElementById('loadingDisplay');
                
                this.evalBar = document.getElementById('evalBar');
                this.evalValue = document.getElementById('evalValue');
                this.evalDetails = document.getElementById('evalDetails');
                this.apiStatus = document.getElementById('apiStatus');
                
                this.initEventListeners();
                this.render();
                this.updateTurnDisplay();
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
                setTimeout(() => this.analyzePosition(), 500);
            }
            
            initEventListeners() {
                document.getElementById('newGameBtn').addEventListener('click', () => this.newGame());
                document.getElementById('flipBoardBtn').addEventListener('click', () => this.flipBoard());
                document.getElementById('undoBtn').addEventListener('click', () => this.undoMove());
                document.getElementById('analyzeBtn').addEventListener('click', () => this.analyzePosition());
                
                this.boardElement.addEventListener('click', (e) => {
                    const square = e.target.closest('.square');
                    if (!square) return;
                    
                    const row = parseInt(square.dataset.row);
                    const col = parseInt(square.dataset.col);
                    this.handleSquareClick(row, col);
                });
            }
            
            handleSquareClick(row, col) {
                if (this.pendingPromotion) return; // –û–∂–∏–¥–∞–µ–º –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—è
                
                const piece = this.game.board[row][col];
                const currentPlayerColor = this.game.currentPlayer === 'w' ? 'white' : 'black';
                
                if (this.selectedSquare) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–π —Ö–æ–¥ –≤ –ª–µ–≥–∞–ª—å–Ω—ã—Ö
                    const move = this.legalMoves.find(m => m.row === row && m.col === col);
                    
                    if (move) {
                        // –•–æ–¥ –≤–æ–∑–º–æ–∂–µ–Ω
                        this.makeMove(this.selectedSquare, { row, col }, move);
                        this.selectedSquare = null;
                        this.legalMoves = [];
                    } else {
                        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–±–∏—Ä–∞–µ–º –¥—Ä—É–≥—É—é —Ñ–∏–≥—É—Ä—É
                        if (piece && this.isPieceColor(piece, currentPlayerColor)) {
                            this.selectedSquare = { row, col };
                            this.legalMoves = this.game.generatePieceMoves(row, col);
                        } else {
                            this.selectedSquare = null;
                            this.legalMoves = [];
                        }
                    }
                } else {
                    // –í—ã–±–∏—Ä–∞–µ–º —Ñ–∏–≥—É—Ä—É, –µ—Å–ª–∏ –æ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
                    if (piece && this.isPieceColor(piece, currentPlayerColor)) {
                        this.selectedSquare = { row, col };
                        this.legalMoves = this.game.generatePieceMoves(row, col);
                    }
                }
                
                this.render();
            }
            
            isPieceColor(piece, color) {
                return (color === 'white' && piece === piece.toUpperCase()) ||
                       (color === 'black' && piece === piece.toLowerCase());
            }
            
            makeMove(from, to, moveData) {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—à–∫–∏
                const piece = this.game.board[from.row][from.col];
                if (piece.toLowerCase() === 'p' && (to.row === 0 || to.row === 7)) {
                    // –¢—Ä–µ–±—É–µ–º –≤—ã–±–æ—Ä–∞ —Ñ–∏–≥—É—Ä—ã
                    this.pendingPromotion = { from, to, moveData };
                    this.showPromotionDialog(to.row === 0 ? 'white' : 'black');
                    return;
                }
                
                // –í—ã–ø–æ–ª–Ω—è–µ–º —Ö–æ–¥
                const success = this.game.makeMove(from, to, moveData.promotion || 'q');
                
                if (success) {
                    this.selectedSquare = null;
                    this.legalMoves = [];
                    this.render();
                    this.updateTurnDisplay();
                    this.updateFEN();
                    this.updateMoveHistory();
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–∫–æ–Ω—á–∞–Ω–∏–µ –∏–≥—Ä—ã
                    this.checkGameEnd();
                    
                    // –ê–Ω–∞–ª–∏–∑ –ø–æ–∑–∏—Ü–∏–∏
                    this.analyzePosition();
                }
            }
            
            showPromotionDialog(color) {
                const pieces = ['q', 'r', 'b', 'n'];
                const symbols = { 'q': '‚ôï', 'r': '‚ôñ', 'b': '‚ôó', 'n': '‚ôò' };
                
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #28363f;
                    padding: 25px;
                    border-radius: 20px;
                    box-shadow: 0 20px 50px rgba(0,0,0,0.7);
                    z-index: 1000;
                    border: 3px solid #ffd966;
                    text-align: center;
                `;
                
                dialog.innerHTML = `
                    <div style="color: #ffd966; margin-bottom: 20px; font-size: 1.2em;">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–≥—É—Ä—É –¥–ª—è –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—è:</div>
                    <div style="display: flex; gap: 20px; justify-content: center;">
                        ${pieces.map(p => `
                            <div class="promotion-piece" data-piece="${p}" style="
                                font-size: 4em;
                                cursor: pointer;
                                padding: 10px;
                                background: #1e2e38;
                                border-radius: 12px;
                                width: 80px;
                                height: 80px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                border: 2px solid #3f5562;
                                transition: all 0.2s;
                            ">${symbols[p]}</div>
                        `).join('')}
                    </div>
                `;
                
                document.body.appendChild(dialog);
                
                const piecesElements = dialog.querySelectorAll('.promotion-piece');
                piecesElements.forEach(el => {
                    el.addEventListener('mouseenter', () => {
                        el.style.background = '#3f5562';
                        el.style.borderColor = '#ffd966';
                    });
                    el.addEventListener('mouseleave', () => {
                        el.style.background = '#1e2e38';
                        el.style.borderColor = '#3f5562';
                    });
                    
                    el.addEventListener('click', () => {
                        const piece = el.dataset.piece;
                        const { from, to } = this.pendingPromotion;
                        
                        this.game.makeMove(from, to, piece);
                        this.pendingPromotion = null;
                        document.body.removeChild(dialog);
                        
                        this.selectedSquare = null;
                        this.legalMoves = [];
                        this.render();
                        this.updateTurnDisplay();
                        this.updateFEN();
                        this.updateMoveHistory();
                        this.checkGameEnd();
                        this.analyzePosition();
                    });
                });
            }
            
            checkGameEnd() {
                const check = this.game.isCheck();
                const checkmate = this.game.isCheckmate();
                const stalemate = this.game.isStalemate();
                
                if (checkmate) {
                    const winner = this.game.currentPlayer === 'w' ? '–ß–µ—Ä–Ω—ã–µ' : '–ë–µ–ª—ã–µ';
                    this.showMessage(`–ú–∞—Ç! ${winner} –ø–æ–±–µ–¥–∏–ª–∏!`);
                } else if (stalemate) {
                    this.showMessage('–ü–∞—Ç! –ù–∏—á—å—è!');
                } else if (check) {
                    this.checkDisplay.style.display = 'block';
                } else {
                    this.checkDisplay.style.display = 'none';
                }
            }
            
            showMessage(text) {
                const msg = document.createElement('div');
                msg.style.cssText = `
                    position: fixed;
                    top: 30px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #ffd966;
                    color: #1e2e38;
                    padding: 15px 30px;
                    border-radius: 50px;
                    font-weight: bold;
                    font-size: 1.3em;
                    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
                    z-index: 2000;
                    animation: slideDown 0.3s;
                `;
                msg.textContent = text;
                document.body.appendChild(msg);
                
                setTimeout(() => {
                    msg.style.animation = 'fadeOut 0.3s';
                    setTimeout(() => document.body.removeChild(msg), 300);
                }, 3000);
            }
            
            updateTurnDisplay() {
                const isWhiteTurn = this.game.currentPlayer === 'w';
                this.turnIcon.textContent = isWhiteTurn ? '‚ö™' : '‚ö´';
                this.turnText.textContent = isWhiteTurn ? '–•–æ–¥ –±–µ–ª—ã—Ö' : '–•–æ–¥ —á–µ—Ä–Ω—ã—Ö';
            }
            
            updateFEN() {
                this.fenDisplay.textContent = this.game.getFEN();
            }
            
            updateMoveHistory() {
                this.moveHistoryElement.innerHTML = '';
                
                for (let i = 0; i < this.game.moveHistory.length; i += 2) {
                    const moveNumber = Math.floor(i / 2) + 1;
                    
                    const numDiv = document.createElement('div');
                    numDiv.className = 'move-number';
                    numDiv.textContent = moveNumber + '.';
                    
                    const whiteDiv = document.createElement('div');
                    whiteDiv.className = 'white-move';
                    whiteDiv.textContent = this.game.moveHistory[i]?.notation || '';
                    whiteDiv.addEventListener('click', () => this.jumpToMove(i));
                    
                    const blackDiv = document.createElement('div');
                    blackDiv.className = 'black-move';
                    blackDiv.textContent = this.game.moveHistory[i+1]?.notation || '';
                    if (this.game.moveHistory[i+1]) {
                        blackDiv.addEventListener('click', () => this.jumpToMove(i+1));
                    }
                    
                    this.moveHistoryElement.appendChild(numDiv);
                    this.moveHistoryElement.appendChild(whiteDiv);
                    this.moveHistoryElement.appendChild(blackDiv);
                }
            }
            
            jumpToMove(index) {
                if (index < 0 || index >= this.game.moveHistory.length) return;
                
                const targetFEN = this.game.moveHistory[index].fen;
                this.game.loadFromFEN(targetFEN);
                this.game.moveHistory = this.game.moveHistory.slice(0, index + 1);
                this.game.positionHistory = this.game.positionHistory.slice(0, index + 2);
                this.game.lastMove = this.game.moveHistory[index];
                this.game.currentPlayer = this.game.moveHistory[index].fen.split(' ')[1];
                
                this.selectedSquare = null;
                this.legalMoves = [];
                this.render();
                this.updateTurnDisplay();
                this.updateFEN();
                this.updateMoveHistory();
                this.checkGameEnd();
                this.analyzePosition();
            }
            
            render() {
                this.boardElement.innerHTML = '';
                
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        const displayRow = this.flipped ? 7 - r : r;
                        const displayCol = this.flipped ? 7 - c : c;
                        
                        const square = document.createElement('div');
                        square.className = `square ${(displayRow + displayCol) % 2 === 0 ? 'light' : 'dark'}`;
                        square.dataset.row = displayRow;
                        square.dataset.col = displayCol;
                        
                        // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                        const coord = document.createElement('span');
                        coord.className = 'coordinate';
                        coord.textContent = String.fromCharCode(97 + displayCol) + (8 - displayRow);
                        square.appendChild(coord);
                        
                        // –§–∏–≥—É—Ä–∞
                        const piece = this.game.board[displayRow][displayCol];
                        if (piece) {
                            const pieceSpan = document.createElement('span');
                            pieceSpan.className = `piece ${piece === piece.toUpperCase() ? 'white' : 'black'}`;
                            pieceSpan.textContent = pieceSymbols[piece];
                            square.appendChild(pieceSpan);
                        }
                        
                        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π
                        if (this.selectedSquare && this.selectedSquare.row === displayRow && this.selectedSquare.col === displayCol) {
                            square.classList.add('selected');
                        }
                        
                        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ö–æ–¥–∞
                        if (this.game.lastMove) {
                            if (this.game.lastMove.from.row === displayRow && this.game.lastMove.from.col === displayCol) {
                                square.classList.add('last-move-from');
                            }
                            if (this.game.lastMove.to.row === displayRow && this.game.lastMove.to.col === displayCol) {
                                square.classList.add('last-move-to');
                            }
                        }
                        
                        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–æ—Ä–æ–ª—è –ø–æ–¥ —à–∞—Ö–æ–º
                        if (this.game.isCheck()) {
                            const kingPos = this.game.kingPositions[this.game.currentPlayer];
                            if (kingPos.row === displayRow && kingPos.col === displayCol) {
                                square.classList.add('checked');
                            }
                        }
                        
                        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ª–µ–≥–∞–ª—å–Ω—ã—Ö —Ö–æ–¥–æ–≤
                        if (this.legalMoves.length > 0) {
                            for (let move of this.legalMoves) {
                                if (move.row === displayRow && move.col === displayCol) {
                                    if (this.game.board[displayRow][displayCol]) {
                                        square.classList.add('legal-capture');
                                    } else {
                                        square.classList.add('legal-move');
                                    }
                                    break;
                                }
                            }
                        }
                        
                        this.boardElement.appendChild(square);
                    }
                }
            }
            
            newGame() {
                this.game = new ChessGame();
                this.selectedSquare = null;
                this.legalMoves = [];
                this.pendingPromotion = null;
                this.flipped = false;
                
                this.render();
                this.updateTurnDisplay();
                this.updateFEN();
                this.updateMoveHistory();
                this.checkGameEnd();
                this.analyzePosition();
            }
            
            flipBoard() {
                this.flipped = !this.flipped;
                this.render();
            }
            
            undoMove() {
                this.game.undoMove();
                this.selectedSquare = null;
                this.legalMoves = [];
                this.pendingPromotion = null;
                
                this.render();
                this.updateTurnDisplay();
                this.updateFEN();
                this.updateMoveHistory();
                this.checkGameEnd();
                this.analyzePosition();
            }
            
            async analyzePosition() {
                const fen = this.game.getFEN();
                
                this.loadingDisplay.style.display = 'flex';
                this.apiStatus.innerHTML = '–ó–∞–ø—Ä–æ—Å –∫ Lichess...';
                this.errorDisplay.style.display = 'none';
                
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω–æ–µ API Lichess
                    const response = await fetch(`https://lichess.org/api/cloud-eval?fen=${encodeURIComponent(fen)}&multiPv=1`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data && data.pvs && data.pvs.length > 0) {
                        const evalData = data.pvs[0];
                        let score = 0;
                        
                        if (evalData.cp !== undefined) {
                            score = evalData.cp / 100;
                        } else if (evalData.mate !== undefined) {
                            score = evalData.mate > 0 ? 10 : -10; // –£—Å–ª–æ–≤–Ω–æ
                        }
                        
                        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        let percent = 50 + score * 8;
                        percent = Math.min(95, Math.max(5, percent));
                        this.evalBar.style.width = percent + '%';
                        
                        if (evalData.mate) {
                            this.evalValue.innerHTML = evalData.mate > 0 ? 
                                `<span style="color: #4CAF50">–ú–∞—Ç —á–µ—Ä–µ–∑ ${evalData.mate}</span>` : 
                                `<span style="color: #f44336">–ú–∞—Ç —á–µ—Ä–µ–∑ ${-evalData.mate}</span>`;
                        } else {
                            this.evalValue.textContent = (score > 0 ? '+' : '') + score.toFixed(2);
                        }
                        
                        // –õ—É—á—à–∏–π —Ö–æ–¥
                        const bestMove = evalData.moves.split(' ')[0];
                        const from = bestMove.substring(0, 2);
                        const to = bestMove.substring(2, 4);
                        const promotion = bestMove.length > 4 ? bestMove[4] : '';
                        
                        this.evalDetails.innerHTML = `
                            –ì–ª—É–±–∏–Ω–∞: ${data.depth || '?'}<br>
                            –õ—É—á—à–∏–π —Ö–æ–¥: ${from} ‚Üí ${to} ${promotion ? '=' + promotion.toUpperCase() : ''}<br>
                            –í–∞—Ä–∏–∞–Ω—Ç: ${evalData.moves}
                        `;
                        
                        this.apiStatus.innerHTML = '‚úÖ –ê–Ω–∞–ª–∏–∑ –ø–æ–ª—É—á–µ–Ω';
                    } else {
                        throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
                    }
                } catch (error) {
                    console.warn('–û—à–∏–±–∫–∞ API Lichess:', error);
                    
                    // –õ–æ–∫–∞–ª—å–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞
                    this.evalBar.style.width = '50%';
                    this.evalValue.textContent = '0.0';
                    this.evalDetails.innerHTML = '–ì–ª—É–±–∏–Ω–∞: –ª–æ–∫–∞–ª—å–Ω–æ<br>–û—Ü–µ–Ω–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                    this.apiStatus.innerHTML = '‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º';
                    this.errorDisplay.style.display = 'block';
                    this.errorDisplay.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ü–µ–Ω–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.';
                } finally {
                    this.loadingDisplay.style.display = 'none';
                }
            }
        }
        
        // –ó–∞–ø—É—Å–∫
        window.addEventListener('DOMContentLoaded', () => {
            window.ui = new ChessUI();
        });
    })();
</script>
</body>
</html>
