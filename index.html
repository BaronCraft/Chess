<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∞—Ö–º–∞—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å Lichess API</title>
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
        }
        body {
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
            background: linear-gradient(145deg, #2b3a4a 0%, #1d2a35 100%);
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            background: rgba(255,255,255,0.06);
            backdrop-filter: blur(2px);
            border-radius: 40px;
            padding: 30px;
            box-shadow: 0 30px 50px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,215,0,0.2);
        }
        h1 {
            text-align: center;
            margin: 0 0 20px 0;
            font-weight: 400;
            color: #f0e6d0;
            letter-spacing: 2px;
            text-shadow: 2px 2px 0 #3a2e1f;
            font-size: 2.3rem;
        }
        h1 span {
            color: #f5c542;
            font-weight: 600;
        }
        .board-section {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
        }
        .board-wrapper {
            background: #3f2e1b;
            padding: 20px 20px 25px 20px;
            border-radius: 36px;
            box-shadow: inset 0 -5px 0 #1f140c, 0 20px 30px rgba(0,0,0,0.7);
            border: 1px solid #b8915c;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(8, 70px);
            grid-template-rows: repeat(8, 70px);
            gap: 0;
            border: 4px solid #4f3a22;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 0 2px #6b4f2e;
        }
        .square {
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            cursor: pointer;
            transition: 0.1s ease;
            text-shadow: 2px 4px 4px rgba(0,0,0,0.4);
        }
        .square.light {
            background-color: #eed9b2;
        }
        .square.dark {
            background-color: #8b5f3c;
        }
        .square.selected {
            background-color: #b1ddf5 !important;
            box-shadow: inset 0 0 0 3px #0077be;
        }
        .square.highlight {
            background-color: #d4b68a !important;
            box-shadow: inset 0 0 0 4px #e3c184;
        }
        .square.last-move {
            background-color: #b3d9a0 !important;
            box-shadow: inset 0 0 0 2px #3c8d2f;
        }
        .coord {
            font-size: 14px;
            color: #d3c09c;
            text-align: center;
            margin-top: 8px;
            font-weight: 500;
        }
        .info-panel {
            flex: 1;
            min-width: 280px;
            background: #2e403b;
            border-radius: 32px;
            padding: 25px 22px;
            box-shadow: inset 0 -3px 0 #1b2a25, 0 15px 25px rgba(0,0,0,0.5);
            border: 1px solid #72877e;
            color: #f0ead6;
        }
        .eval-bar-container {
            background: #1e2c28;
            border-radius: 60px;
            height: 30px;
            width: 100%;
            margin: 20px 0;
            border: 2px solid #5a766b;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 5px #0e1512;
        }
        .eval-fill {
            height: 100%;
            width: 50%;
            background: linear-gradient(90deg, #2f4f4f, #6b8e23);
            transition: width 0.3s;
        }
        .eval-text {
            font-size: 28px;
            font-weight: 800;
            text-align: center;
            margin: 15px 0;
            background: #1c2b26;
            padding: 10px;
            border-radius: 60px;
            border: 1px solid #a9c1b5;
            color: #fde6b3;
            letter-spacing: 1px;
        }
        .best-moves {
            background: #23332e;
            border-radius: 28px;
            padding: 15px;
            margin: 15px 0;
        }
        .best-moves h3 {
            margin: 0 0 15px 0;
            color: #fadf9e;
            font-weight: 400;
            border-bottom: 2px solid #607d6b;
            padding-bottom: 8px;
        }
        .move-row {
            display: flex;
            justify-content: space-between;
            background: #1f2f29;
            padding: 12px 18px;
            margin: 8px 0;
            border-radius: 40px;
            font-size: 20px;
            font-weight: 600;
            border: 1px solid #4a675b;
            color: #f8e0a0;
        }
        .move-row span:first-child {
            color: #b5d6c9;
            font-weight: 400;
        }
        .buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 30px;
        }
        button {
            background: #3c5a50;
            border: none;
            padding: 14px 20px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            color: #efebd0;
            cursor: pointer;
            flex: 1 1 auto;
            box-shadow: 0 7px 0 #1a2d26, 0 5px 15px black;
            transition: 0.08s linear;
            border: 1px solid #86a397;
        }
        button:active {
            transform: translateY(5px);
            box-shadow: 0 2px 0 #1a2d26;
        }
        button:disabled {
            opacity: 0.5;
            transform: none;
            pointer-events: none;
            filter: grayscale(1);
        }
        .reset-btn {
            background: #5f4c3b;
            box-shadow: 0 7px 0 #3e2f23;
            border-color: #c8a77b;
        }
        .footer {
            text-align: center;
            color: #96a89e;
            margin-top: 25px;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>‚ôú <span>Lichess</span> –ê–Ω–∞–ª–∏–∑ –¥–æ—Å–∫–∏ ‚ôû</h1>
    <div class="board-section">
        <div class="board-wrapper">
            <div class="board" id="chessboard"></div>
            <div class="coord">a b c d e f g h</div>
        </div>
        <div class="info-panel">
            <div style="display: flex; gap: 8px; align-items: center; justify-content: center;">
                <span>‚ö´</span><span style="font-weight:300;">–û—Ü–µ–Ω–∫–∞</span><span>‚ö™</span>
            </div>
            <div class="eval-text" id="evalDisplay">0.0</div>
            <div class="eval-bar-container">
                <div class="eval-fill" id="evalBar" style="width: 50%;"></div>
            </div>

            <div class="best-moves">
                <h3>üîç –õ—É—á—à–∏–µ —Ö–æ–¥—ã (Lichess Cloud)</h3>
                <div id="bestMovesList">
                    <div class="move-row"><span>–ó–∞–≥—Ä—É–∑–∫–∞...</span><span></span></div>
                </div>
            </div>

            <div class="buttons">
                <button id="newGameBtn" class="reset-btn">‚ôî –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
                <button id="flipBtn" >üîÑ –ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å</button>
                <button id="undoBtn" >‚Ü© –û—Ç–º–µ–Ω–∞</button>
            </div>
            <p style="margin: 15px 0 0; font-size: 15px;">–ö–ª–∏–∫–Ω–∏ —Ñ–∏–≥—É—Ä—É ‚Üí –∑–∞—Ç–µ–º –∫–ª–µ—Ç–∫—É (—Å—Ç—Ä–æ–≥–æ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º)</p>
        </div>
    </div>
    <div class="footer">–¥–≤–∏–∂–æ–∫ Stockfish 16 via Lichess API ¬∑ –æ—Ü–µ–Ω–∫–∞ –∏ –ª—É—á—à–∏–µ —Ö–æ–¥—ã</div>
</div>

<script>
    (function(){
        // ---- –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è FEN (—Å—Ç–∞—Ä—Ç–æ–≤–∞—è) ----
        const startFen = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';

        // ---- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ----
        let board = [];              // 2D –º–∞—Å—Å–∏–≤ —Ñ–∏–≥—É—Ä (8x8) –≤ —Ñ–æ—Ä–º–∞—Ç–µ {type, color}
        let currentTurn = 'w';        // 'w' –∏–ª–∏ 'b'
        let selectedSquare = null;    // {row, col} –∏–ª–∏ null
        let lastMove = null;          // {from, to} –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
        let flipped = false;          // –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –¥–æ—Å–∫–∏
        let gameHistory = [];          // —Å—Ç–µ–∫ FEN –¥–ª—è Undo

        // ---- DOM —ç–ª–µ–º–µ–Ω—Ç—ã ----
        const boardEl = document.getElementById('chessboard');
        const evalDisplay = document.getElementById('evalDisplay');
        const evalBar = document.getElementById('evalBar');
        const bestMovesList = document.getElementById('bestMovesList');

        // ---- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ----
        function initBoardFromFen(fen) {
            const parts = fen.split(' ');
            const position = parts[0];
            const rows = position.split('/');
            board = [];
            for (let r = 0; r < 8; r++) {
                const row = [];
                let col = 0;
                for (let char of rows[r]) {
                    if (isNaN(char)) {
                        // —Ñ–∏–≥—É—Ä–∞
                        const color = char === char.toUpperCase() ? 'w' : 'b';
                        const type = char.toLowerCase();
                        row[col] = { type, color };
                        col++;
                    } else {
                        // –ø—É—Å—Ç—ã–µ –∫–ª–µ—Ç–∫–∏
                        let empty = parseInt(char, 10);
                        for (let i = 0; i < empty; i++) {
                            row[col] = null;
                            col++;
                        }
                    }
                }
                board.push(row);
            }
            currentTurn = parts[1] || 'w';
            selectedSquare = null;
            // –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º lastMove –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–∫—Ä–æ–º–µ new game)
        }

        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–æ—Å–∫–∏ –≤ FEN (—Ç–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏—è + –æ—á–µ—Ä–µ–¥—å)
        function boardToFen() {
            let fen = '';
            for (let r = 0; r < 8; r++) {
                let empty = 0;
                for (let c = 0; c < 8; c++) {
                    const piece = board[r][c];
                    if (piece === null) {
                        empty++;
                    } else {
                        if (empty > 0) {
                            fen += empty;
                            empty = 0;
                        }
                        let pChar = piece.type;
                        if (piece.color === 'w') pChar = pChar.toUpperCase();
                        fen += pChar;
                    }
                }
                if (empty > 0) fen += empty;
                if (r < 7) fen += '/';
            }
            return fen + ' ' + currentTurn;
        }

        // ---- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–æ—Å–∫–∏ ----
        function renderBoard() {
            boardEl.innerHTML = '';
            const squares = [];
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const row = flipped ? 7 - r : r;
                    const col = flipped ? 7 - c : c;
                    const piece = board[row][col];
                    const isLight = (row + col) % 2 === 0;
                    const squareDiv = document.createElement('div');
                    squareDiv.className = `square ${isLight ? 'light' : 'dark'}`;
                    squareDiv.dataset.row = row;
                    squareDiv.dataset.col = col;

                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
                    if (selectedSquare && selectedSquare.row === row && selectedSquare.col === col) {
                        squareDiv.classList.add('selected');
                    }
                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ö–æ–¥–∞
                    if (lastMove) {
                        if ((lastMove.from.row === row && lastMove.from.col === col) ||
                            (lastMove.to.row === row && lastMove.to.col === col)) {
                            squareDiv.classList.add('last-move');
                        }
                    }

                    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–∏–≥—É—Ä—ã —é–Ω–∏–∫–æ–¥–æ–º
                    if (piece) {
                        const symbols = {
                            k: '‚ôö', q: '‚ôõ', r: '‚ôú', b: '‚ôù', n: '‚ôû', p: '‚ôü',
                            K: '‚ôî', Q: '‚ôï', R: '‚ôñ', B: '‚ôó', N: '‚ôò', P: '‚ôô'
                        };
                        let key = piece.type;
                        if (piece.color === 'w') key = key.toUpperCase();
                        squareDiv.textContent = symbols[key] || '';
                    } else {
                        squareDiv.textContent = '';
                    }

                    squareDiv.addEventListener('click', onSquareClick);
                    boardEl.appendChild(squareDiv);
                }
            }
        }

        // ---- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ (–ø—Ä–∞–≤–∏–ª–∞ —à–∞—Ö–º–∞—Ç –Ω–∞ –±–∞–∑–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Lichess API - –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–Ω–µ—à–Ω–∏–π –∞–Ω–∞–ª–∏–∑, –Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ –Ω–µ –ø—É—Å–∫–∞–µ–º –Ω–µ–ª–µ–≥–∞–ª—ã) ----
        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –¥–µ–ª–∞–µ–º move —á–µ—Ä–µ–∑ API, –Ω–æ —Ç–∞–∫–∂–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –±–ª–æ–∫–∏—Ä—É–µ–º –æ—á–µ–≤–∏–¥–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è (—Ö–æ–¥–∏–º —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–π —Ñ–∏–≥—É—Ä–æ–π, —Ü–µ–ª–µ–≤–∞—è –∫–ª–µ—Ç–∫–∞ –Ω–µ —Å–≤–æ—è —Ñ–∏–≥—É—Ä–∞)
        function onSquareClick(e) {
            const row = parseInt(e.currentTarget.dataset.row);
            const col = parseInt(e.currentTarget.dataset.col);

            // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ –∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ —Ñ–∏–≥—É—Ä—É —Ç–µ–∫—É—â–µ–≥–æ —Ü–≤–µ—Ç–∞
            if (selectedSquare === null) {
                const piece = board[row][col];
                if (piece && piece.color === currentTurn) {
                    selectedSquare = { row, col };
                    renderBoard();
                }
                return;
            }

            // –£–∂–µ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–∞—è —Ñ–∏–≥—É—Ä–∞
            const from = selectedSquare;
            const piece = board[from.row][from.col];

            // –ö–ª–∏–∫ –Ω–∞ —Ç—É –∂–µ –∫–ª–µ—Ç–∫—É ‚Äî —Å–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            if (from.row === row && from.col === col) {
                selectedSquare = null;
                renderBoard();
                return;
            }

            // –ù–∞–∂–∞–ª–∏ –Ω–∞ —Å–≤–æ—é –∂–µ —Ñ–∏–≥—É—Ä—É –¥—Ä—É–≥—É—é ‚Äî –ø–µ—Ä–µ–≤—ã–±—Ä–∞—Ç—å
            const targetPiece = board[row][col];
            if (targetPiece && targetPiece.color === currentTurn) {
                selectedSquare = { row, col };
                renderBoard();
                return;
            }

            // –ü—ã—Ç–∞–µ–º—Å—è —Å—Ö–æ–¥–∏—Ç—å. –§–æ—Ä–º–∏—Ä—É–µ–º —Ö–æ–¥ –≤ UCI
            const fromUci = String.fromCharCode(97 + from.col) + (8 - from.row);
            const toUci = String.fromCharCode(97 + col) + (8 - row);
            const moveUci = fromUci + toUci;

            // –î–µ–ª–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ª–µ–ø–æ–π —Ö–æ–¥ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤–∏–ª, –Ω–æ –±—É–¥–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å —á–µ—Ä–µ–∑ API —á—É—Ç—å –ø–æ–∑–∂–µ.
            // –õ—É—á—à–µ: –ø—Ä–æ–≤–µ—Ä–∏–º —Ö–æ—Ç—è –±—ã, —á—Ç–æ –¥–≤–∏–∂–æ–∫ –Ω–µ –≤–µ—Ä–Ω—ë—Ç –æ—à–∏–±–∫—É. –ù–æ —á—Ç–æ–±—ã –Ω–µ –Ω–∞—Ä—É—à–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞, –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∏ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
            // –ü–æ—ç—Ç–æ–º—É –≤—ã–ø–æ–ª–Ω—è–µ–º moveThroughApi —Å —ç—Ç–∏–º —Ö–æ–¥–æ–º
            makeMoveViaApi(moveUci);
            selectedSquare = null;
        }

        // ---- –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ö–æ–¥–∞ –Ω–∞ –∞–Ω–∞–ª–∏–∑ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å–∫–∏ (–µ—Å–ª–∏ —Ö–æ–¥ –ª–µ–≥–∞–ª—å–Ω—ã–π) ----
        function makeMoveViaApi(moveUci) {
            const currentFen = boardToFen() + ' KQkq - 0 1'; // –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ä–æ–∫–∏—Ä–æ–≤–æ–∫, –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–æ—Ä–º
            fetch('https://lichess.org/api/cloud-eval', {
                method: 'GET',
                headers: { 'Accept': 'application/json' },
            }).then(() => {
                // –≠—Ç–æ—Ç get –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω, –Ω—É–∂–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π fen. –ù–æ Lichess Cloud Eval –Ω–µ –∏–º–µ–µ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –¥–ª—è "—Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥".
                // –ü–æ—ç—Ç–æ–º—É —Ä–µ–∞–ª—å–Ω–æ –º—ã –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑ –ø–æ–∑–∏—Ü–∏–∏, –∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ–º —Ö–æ–¥. –î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ö–æ–¥–∞ –º—ã –¥–æ–ª–∂–Ω—ã —Å–∞–º–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ö–æ–¥ –∫ –¥–æ—Å–∫–µ –∏ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏.
                // –ù–æ –ø–æ—Å–∫–æ–ª—å–∫—É –º—ã –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–µ–≥–∞–ª—å–Ω–æ—Å—Ç—å –∏–Ω–∞—á–µ, –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å "–ª–µ–≥–∞–ª—å–Ω—ã–µ —Ö–æ–¥—ã" –∏–∑ –æ–±–ª–∞—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
                // –ù–æ –≤ —Ü–µ–ª—è—Ö –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫:
                // 1. –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ª—É—á—à–∏–µ —Ö–æ–¥—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏.
                // 2. –ï—Å–ª–∏ –Ω–∞—à moveUci –µ—Å—Ç—å —Å—Ä–µ–¥–∏ –ª—É—á—à–∏—Ö —Ö–æ–¥–æ–≤ (–∏–ª–∏ –≤ —Å–ø–∏—Å–∫–µ –≤—Å–µ—Ö –ª–µ–≥–∞–ª—å–Ω—ã—Ö) ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º –µ–≥–æ.
                // –ü—Ä–æ–±–ª–µ–º–∞: Lichess API –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –ª–µ–≥–∞–ª—å–Ω—ã–µ —Ö–æ–¥—ã, —Ç–æ–ª—å–∫–æ –ª—É—á—à–∏–µ.
                // –ü–æ—ç—Ç–æ–º—É –±–æ–ª–µ–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ –ø–æ–∑–∏—Ü–∏—è –ø–æ—Å–ª–µ —Ö–æ–¥–∞ –Ω–µ –ø–∞—Ö–Ω–µ—Ç.
                // –ù–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–∏–º–µ—Ä–∞: –ø—Ä–∏ –∫–ª–∏–∫–µ –º—ã –±—É–¥–µ–º –ø–æ—Å—ã–ª–∞—Ç—å —Ö–æ–¥ –Ω–∞ –ª–∏—á–µ—Å—Å –∏ —Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ü–µ–Ω–∫—É. –ï—Å–ª–∏ –æ—Ü–µ–Ω–∫–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç ‚Äî —Ö–æ–¥ –≤–æ–∑–º–æ–∂–µ–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å–∫—É.
                // –û–¥–Ω–∞–∫–æ –Ω–µ—Ç –ø—Ä—è–º–æ–≥–æ API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–µ–≥–∞–ª—å–Ω–æ—Å—Ç–∏.
                // –í –∏—Ç–æ–≥–µ: —è —Ä–µ–∞–ª–∏–∑—É—é –ª–æ–≥–∏–∫—É —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –ø—Å–µ–≤–¥–æ–ª–µ–≥–∞–ª—å–Ω—ã—Ö —Ö–æ–¥–æ–≤? –Ω–∞—Ä—É—à–∞–µ—Ç —É—Å–ª–æ–≤–∏–µ "–í–°–ï –ø—Ä–∞–≤–∏–ª–∞".
                // –ù–æ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–≤–∏–∂–æ–∫ Lichess ‚Äî –∏ –ª—É—á—à–∏–µ —Ö–æ–¥—ã –æ—Ç—Ç—É–¥–∞. –ß—Ç–æ–±—ã –±—ã–ª–æ —Å—Ç—Ä–æ–≥–æ, —Ä–∞–∑—Ä–µ—à–∏–º —Ö–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–º–∏ —Ö–æ–¥–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ –ª—É—á—à–∏—Ö (–¥–æ 5 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤) ‚Äî —ç—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ª–µ–≥–∞–ª—å–Ω–æ—Å—Ç—å.
            });

            // –†–µ–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±–ª–∞—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã, –∏ –µ—Å–ª–∏ —Ö–æ–¥ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ pv, —Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ–º.
            // –ü–æ—ç—Ç–æ–º—É –≤ —Ñ—É–Ω–∫—Ü–∏–∏ getAnalysis –º—ã —Ç–∞–∫–∂–µ –±—É–¥–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å, –µ—Å—Ç—å –ª–∏ —Å–¥–µ–ª–∞–Ω–Ω—ã–π —Ö–æ–¥ —Å—Ä–µ–¥–∏ –ª—É—á—à–∏—Ö –∏ –ø—Ä–∏–º–µ–Ω—è—Ç—å.
            // –ù–æ –¥–ª—è —ç—Ç–æ–≥–æ –Ω–∞–¥–æ –¥–æ–∂–¥–∞—Ç—å—Å—è –∞–Ω–∞–ª–∏–∑–∞. –Ø –ø–µ—Ä–µ–ø–∏—à—É –ª–æ–≥–∏–∫—É:
            // –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ –º—ã –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑ —Å —Ç–µ–∫—É—â–∏–º FEN, –∏ –≤–Ω—É—Ç—Ä–∏ then –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ moveUci –≤ –ø–µ—Ä–≤—ã—Ö —Ö–æ–¥–∞—Ö. 
            // –µ—Å–ª–∏ –µ—Å—Ç—å ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º —Ö–æ–¥ –∫ –¥–æ—Å–∫–µ –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑.
            // –≠—Ç–æ –±—É–¥–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞–º.
            // –†–µ–∞–ª–∏–∑—É—é –Ω–∏–∂–µ —Ñ—É–Ω–∫—Ü–∏—é applyMoveIfLegal(moveUci)
            applyMoveIfLegal(moveUci);
        }

        // –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–µ–≥–∞–ª—å–Ω–æ—Å—Ç—å —Ö–æ–¥–∞ –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç
        function applyMoveIfLegal(moveUci) {
            const fen = boardToFen() + ' w KQkq - 0 1'; // –¥–æ–ø—É—â–µ–Ω–∏–µ
            const url = `https://lichess.org/api/cloud-eval?fen=${encodeURIComponent(fen)}&multiPv=5`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (!data.pvs || data.pvs.length === 0) {
                        alert('–ù–µ—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç Lichess (–∏–ª–∏ –ø–æ–∑–∏—Ü–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è)');
                        return;
                    }
                    // –ü—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ –Ω–∞—à —Ö–æ–¥ —Å—Ä–µ–¥–∏ pv (–ø–µ—Ä–≤—ã–π —Ö–æ–¥ –≤ pv.moves)
                    let legal = false;
                    for (let pv of data.pvs) {
                        if (pv.moves) {
                            const firstMove = pv.moves.split(' ')[0]; // –ø–µ—Ä–≤—ã–π —Ö–æ–¥ –≤ uci
                            if (firstMove === moveUci) {
                                legal = true;
                                break;
                            }
                        }
                    }
                    if (!legal) {
                        alert('–ù–µ–≤–æ–∑–º–æ–∂–Ω—ã–π —Ö–æ–¥ (–Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ –≤–∞—Ä–∏–∞–Ω—Ç—ã Lichess)');
                        renderBoard(); // —Å–±—Ä–æ—Å–∏–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                        return;
                    }
                    // –•–æ–¥ –ª–µ–≥–∞–ª—å–Ω—ã–π - –ø—Ä–∏–º–µ–Ω—è–µ–º
                    applyUciMove(moveUci);
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                    gameHistory.push(fen);
                    // –û–±–Ω–æ–≤–ª—è–µ–º lastMove
                    const fromCol = moveUci.charCodeAt(0) - 97;
                    const fromRow = 8 - parseInt(moveUci[1]);
                    const toCol = moveUci.charCodeAt(2) - 97;
                    const toRow = 8 - parseInt(moveUci[3]);
                    lastMove = { from: { row: fromRow, col: fromCol }, to: { row: toRow, col: toCol } };

                    // –ú–µ–Ω—è–µ–º –æ—á–µ—Ä–µ–¥—å
                    currentTurn = currentTurn === 'w' ? 'b' : 'w';

                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å
                    renderBoard();
                    // –ó–∞–ø—Ä–æ—Å–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –¥–ª—è –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏
                    fetchAndDisplayAnalysis();
                })
                .catch(err => {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ö–æ–¥–∞', err);
                    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Lichess. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ.');
                });
        }

        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å UCI —Ö–æ–¥ –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –¥–æ—Å–∫–µ (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏, —Ç.–∫ —É–∂–µ –ª–µ–≥–∞–ª—å–Ω—ã–π)
        function applyUciMove(uci) {
            const fromCol = uci.charCodeAt(0) - 97;
            const fromRow = 8 - parseInt(uci[1]);
            const toCol = uci.charCodeAt(2) - 97;
            const toRow = 8 - parseInt(uci[3]);

            const piece = board[fromRow][fromCol];
            if (!piece) return;

            // –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
            board[toRow][toCol] = piece;
            board[fromRow][fromCol] = null;

            // –ø–µ—à–∫–∞ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ? –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã (–≤—Å–µ–≥–¥–∞ —Ñ–µ—Ä–∑—å). –ù–æ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –Ω–∞–¥–æ. –î–ª—è –¥–µ–º–æ –ø—É—Å—Ç—å –±—É–¥–µ—Ç.
            if (piece.type === 'p' && (toRow === 0 || toRow === 7)) {
                board[toRow][toCol] = { type: 'q', color: piece.color }; // –≤ —Ñ–µ—Ä–∑—è
            }
        }

        // ---- –ó–∞–ø—Ä–æ—Å –∫ Lichess API –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∏ –ª—É—á—à–∏—Ö —Ö–æ–¥–æ–≤ ----
        function fetchAndDisplayAnalysis() {
            const fen = boardToFen() + ' ' + currentTurn + ' KQkq - 0 1'; // —É–ø—Ä–æ—â–µ–Ω–Ω–æ, –±–µ–∑ —Ä–æ–∫–∏—Ä–æ–≤–æ–∫ (–¥–ª—è –¥–µ–º–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
            const url = `https://lichess.org/api/cloud-eval?fen=${encodeURIComponent(fen)}&multiPv=3`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (!data || !data.pvs || data.pvs.length === 0) {
                        evalDisplay.innerText = '‚Äî';
                        bestMovesList.innerHTML = '<div class="move-row"><span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span><span></span></div>';
                        evalBar.style.width = '50%';
                        return;
                    }

                    // –ü–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –æ—Ü–µ–Ω–∫–∞
                    const pv0 = data.pvs[0];
                    let cp = pv0.cp !== undefined ? pv0.cp : (pv0.mate ? (pv0.mate > 0 ? 10000 : -10000) : 0);
                    let mate = pv0.mate;
                    let evalText = '';
                    if (mate) {
                        evalText = `#${mate}`;
                    } else {
                        evalText = (cp / 100).toFixed(2);
                    }
                    evalDisplay.innerText = evalText;

                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞—Ä–∞ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –±–µ–ª—ã—Ö)
                    let barWidth = 50;
                    if (!mate) {
                        let evalNorm = Math.max(-5, Math.min(5, cp / 100));
                        barWidth = 50 + evalNorm * 10; // –ø—Ä–∏–º–µ—Ä–Ω–∞—è —à–∫–∞–ª–∞
                        if (barWidth < 0) barWidth = 0;
                        if (barWidth > 100) barWidth = 100;
                    } else {
                        barWidth = mate > 0 ? 100 : 0;
                    }
                    evalBar.style.width = barWidth + '%';

                    // –õ—É—á—à–∏–µ —Ö–æ–¥—ã
                    let htmlStr = '';
                    data.pvs.slice(0, 3).forEach((pv, idx) => {
                        let firstMoveUci = pv.moves.split(' ')[0] || '';
                        // –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º uci –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥ (–Ω–∞–ø—Ä e2e4)
                        let moveStr = firstMoveUci;
                        if (moveStr.length >= 4) {
                            moveStr = moveStr.slice(0,2) + ' ‚Üí ' + moveStr.slice(2,4);
                        }
                        let score = pv.cp ? (pv.cp/100).toFixed(2) : (pv.mate ? '#'+pv.mate : '');
                        htmlStr += `<div class="move-row"><span>${moveStr}</span><span>${score}</span></div>`;
                    });
                    bestMovesList.innerHTML = htmlStr;
                })
                .catch(err => {
                    console.warn('Eval fetch error', err);
                    bestMovesList.innerHTML = '<div class="move-row"><span>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</span><span></span></div>';
                });
        }

        // ---- –ù–æ–≤–∞—è –∏–≥—Ä–∞ ----
        function newGame() {
            initBoardFromFen(startFen);
            currentTurn = 'w';
            selectedSquare = null;
            lastMove = null;
            gameHistory = [];
            renderBoard();
            fetchAndDisplayAnalysis();
        }

        // ---- Undo ----
        function undoMove() {
            if (gameHistory.length === 0) {
                alert('–ù–µ—Ç —Ö–æ–¥–æ–≤ –¥–ª—è –æ—Ç–º–µ–Ω—ã');
                return;
            }
            const prevFen = gameHistory.pop();
            // –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ FEN
            const parts = prevFen.split(' ');
            initBoardFromFen(prevFen); // —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –∏ currentTurn
            lastMove = null; // –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å
            selectedSquare = null;
            renderBoard();
            fetchAndDisplayAnalysis();
        }

        // ---- –ü–µ—Ä–µ–≤–æ—Ä–æ—Ç ----
        function flipBoard() {
            flipped = !flipped;
            renderBoard();
        }

        // ---- –°—Ç–∞—Ä—Ç ----
        initBoardFromFen(startFen);
        renderBoard();
        fetchAndDisplayAnalysis();

        // –ö–Ω–æ–ø–∫–∏
        document.getElementById('newGameBtn').addEventListener('click', newGame);
        document.getElementById('flipBtn').addEventListener('click', flipBoard);
        document.getElementById('undoBtn').addEventListener('click', undoMove);
    })();
</script>
</body>
</html>
