<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∞—Ö–º–∞—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å Lichess API ‚Äî –ø–æ–ª–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å</title>
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
        }
        body {
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
            background: linear-gradient(145deg, #1e3a2f 0%, #132822 100%);
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            max-width: 1300px;
            width: 100%;
            background: rgba(10, 25, 20, 0.85);
            backdrop-filter: blur(4px);
            border-radius: 48px;
            padding: 30px;
            box-shadow: 0 30px 50px rgba(0, 0, 0, 0.8), inset 0 1px 3px rgba(255, 215, 0, 0.3);
            border: 1px solid #c9a96b;
        }
        h1 {
            text-align: center;
            margin: 0 0 20px 0;
            font-weight: 400;
            color: #f5e7c8;
            letter-spacing: 2px;
            text-shadow: 2px 2px 0 #2a4a3a;
            font-size: 2.5rem;
        }
        h1 span {
            color: #ffd966;
            font-weight: 600;
        }
        .board-section {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
        }
        .board-wrapper {
            background: #2d4a3a;
            padding: 20px 20px 25px 20px;
            border-radius: 42px;
            box-shadow: inset 0 -6px 0 #1b3226, 0 25px 35px rgba(0, 0, 0, 0.7);
            border: 1px solid #e3b87c;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(8, 75px);
            grid-template-rows: repeat(8, 75px);
            gap: 0;
            border: 5px solid #5f4a2e;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 0 3px #a47e54;
        }
        .square {
            width: 75px;
            height: 75px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 52px;
            cursor: pointer;
            transition: 0.08s ease;
            text-shadow: 2px 4px 5px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        .square.light {
            background-color: #edd6b0;
        }
        .square.dark {
            background-color: #b5885a;
        }
        .square.selected {
            background-color: #b0d9ff !important;
            box-shadow: inset 0 0 0 4px #004b8f;
        }
        .square.possible-move {
            position: relative;
        }
        .square.possible-move::after {
            content: "";
            position: absolute;
            width: 24px;
            height: 24px;
            background: rgba(0, 120, 0, 0.5);
            border-radius: 50%;
            pointer-events: none;
            border: 2px solid #a0d6a0;
            box-shadow: 0 0 10px #00aa00;
        }
        .square.possible-capture::after {
            content: "";
            position: absolute;
            width: 60px;
            height: 60px;
            border: 5px solid rgba(180, 0, 0, 0.6);
            border-radius: 50%;
            background: rgba(255, 0, 0, 0.15);
            pointer-events: none;
            box-shadow: 0 0 15px #ff4d4d;
        }
        .square.last-move {
            background-color: #c7e5b0 !important;
            box-shadow: inset 0 0 0 3px #2f7d2f;
        }
        .coord {
            font-size: 16px;
            color: #efe2c6;
            text-align: center;
            margin-top: 12px;
            font-weight: 600;
            letter-spacing: 4px;
        }
        .info-panel {
            flex: 1;
            min-width: 300px;
            background: #1c3d31;
            border-radius: 38px;
            padding: 25px;
            box-shadow: inset 0 -4px 0 #0e2820, 0 20px 30px rgba(0, 0, 0, 0.6);
            border: 1px solid #9eba8b;
            color: #f2f0d7;
        }
        .piece-indicator {
            font-size: 32px;
            background: #14362b;
            padding: 12px 20px;
            border-radius: 50px;
            text-align: center;
            margin: 5px 0 20px;
            border: 2px solid #e3b87c;
            box-shadow: inset 0 2px 5px #0b1f18;
            color: #ffeca2;
        }
        .eval-bar-container {
            background: #142e24;
            border-radius: 60px;
            height: 35px;
            width: 100%;
            margin: 20px 0;
            border: 3px solid #768e7a;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 3px 8px #091510;
        }
        .eval-fill {
            height: 100%;
            width: 50%;
            background: linear-gradient(90deg, #3b6e5b, #c9a96b);
            transition: width 0.3s;
        }
        .eval-text {
            font-size: 32px;
            font-weight: 800;
            text-align: center;
            margin: 15px 0;
            background: #16352a;
            padding: 15px;
            border-radius: 60px;
            border: 2px solid #edd19b;
            color: #ffeca2;
            letter-spacing: 2px;
            font-family: monospace;
        }
        .best-moves {
            background: #1a3f32;
            border-radius: 32px;
            padding: 18px;
            margin: 20px 0;
            border: 1px solid #bcaa7a;
        }
        .best-moves h3 {
            margin: 0 0 15px 0;
            color: #fad980;
            font-weight: 400;
            border-bottom: 3px solid #6e947a;
            padding-bottom: 10px;
            font-size: 22px;
        }
        .move-row {
            display: flex;
            justify-content: space-between;
            background: #124130;
            padding: 14px 22px;
            margin: 10px 0;
            border-radius: 50px;
            font-size: 22px;
            font-weight: 600;
            border: 2px solid #6f8b72;
            color: #ffeab3;
        }
        .move-row span:first-child {
            color: #cce3d4;
            font-weight: 400;
        }
        .buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 30px;
        }
        button {
            background: #2f604a;
            border: none;
            padding: 16px 22px;
            border-radius: 60px;
            font-size: 20px;
            font-weight: 600;
            color: #fbf3d7;
            cursor: pointer;
            flex: 1 1 auto;
            box-shadow: 0 8px 0 #1a3d2f, 0 6px 18px black;
            transition: 0.07s linear;
            border: 1px solid #c6ad78;
        }
        button:active {
            transform: translateY(6px);
            box-shadow: 0 2px 0 #1a3d2f;
        }
        button:disabled {
            opacity: 0.4;
            transform: none;
            pointer-events: none;
        }
        .reset-btn {
            background: #735f40;
            box-shadow: 0 8px 0 #4e3e28;
            border-color: #e3b06c;
        }
        .footer {
            text-align: center;
            color: #b3cfbf;
            margin-top: 25px;
            font-size: 16px;
            font-weight: 300;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>‚ôõ <span>Lichess</span> –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ ‚ôö</h1>
    <div class="board-section">
        <div class="board-wrapper">
            <div class="board" id="chessboard"></div>
            <div class="coord">a  b  c  d  e  f  g  h</div>
        </div>
        <div class="info-panel">
            <div class="piece-indicator" id="pieceIndicator">‚ö™ –•–æ–¥ –±–µ–ª—ã—Ö</div>
            <div class="eval-text" id="evalDisplay">0.00</div>
            <div class="eval-bar-container">
                <div class="eval-fill" id="evalBar" style="width: 50%;"></div>
            </div>

            <div class="best-moves">
                <h3>üîç –õ—É—á—à–∏–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è (Stockfish 16+)</h3>
                <div id="bestMovesList">
                    <div class="move-row"><span>–ó–∞–≥—Ä—É–∑–∫–∞ —Å Lichess...</span><span></span></div>
                </div>
            </div>

            <div class="buttons">
                <button id="newGameBtn" class="reset-btn">‚ôî –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
                <button id="flipBtn">üîÑ –ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å</button>
                <button id="undoBtn">‚Ü© –û—Ç–º–µ–Ω–∞</button>
            </div>
            <p style="margin: 20px 0 5px; font-size: 18px; text-align: center;">‚¨§ –∑–µ–ª—ë–Ω—ã–π ‚Äî —Ö–æ–¥, üî¥ –∫—Ä–∞—Å–Ω—ã–π ‚Äî –≤–∑—è—Ç–∏–µ</p>
        </div>
    </div>
    <div class="footer">–¥–≤–∏–∂–æ–∫ Lichess (–º–Ω–æ–≥–æ–≤–∞—Ä–∏–∞–Ω—Ç–Ω—ã–π) ¬∑ –ø–æ–ª–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å ¬∑ –≤—Å–µ –ª–µ–≥–∞–ª—å–Ω—ã–µ —Ö–æ–¥—ã –ø–æ–¥—Å–≤–µ—á–µ–Ω—ã</div>
</div>

<script>
    (function() {
        // --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ---
        const startFen = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';

        // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ ---
        let board = [];
        let currentTurn = 'w';
        let selectedSquare = null;
        let lastMove = null;
        let flipped = false;
        let gameHistory = [];

        // --- –ö—ç—à –ª–µ–≥–∞–ª—å–Ω—ã—Ö —Ö–æ–¥–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ (UCI —Å—Ç—Ä–æ–∫–∏) ---
        let legalMovesCache = new Set();  // –≤—Å–µ –ª–µ–≥–∞–ª—å–Ω—ã–µ —Ö–æ–¥—ã –≤ UCI (–Ω–∞ —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é)
        let currentEvalData = null;

        // --- DOM —ç–ª–µ–º–µ–Ω—Ç—ã ---
        const boardEl = document.getElementById('chessboard');
        const evalDisplay = document.getElementById('evalDisplay');
        const evalBar = document.getElementById('evalBar');
        const bestMovesList = document.getElementById('bestMovesList');
        const pieceIndicator = document.getElementById('pieceIndicator');

        // --- –£—Ç–∏–ª–∏—Ç—ã ---
        function getPieceSymbol(piece) {
            if (!piece) return '';
            const symbols = {
                k: '‚ôö', q: '‚ôõ', r: '‚ôú', b: '‚ôù', n: '‚ôû', p: '‚ôü',
                K: '‚ôî', Q: '‚ôï', R: '‚ôñ', B: '‚ôó', N: '‚ôò', P: '‚ôô'
            };
            let key = piece.type;
            if (piece.color === 'w') key = key.toUpperCase();
            return symbols[key] || '';
        }

        // --- –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–æ—Å–∫–∏ –≤ FEN (–ø–æ–∑–∏—Ü–∏—è + –æ—á–µ—Ä–µ–¥—å + —É–ø—Ä–æ—â—ë–Ω–Ω—ã–µ —Ä–æ–∫–∏—Ä–æ–≤–∫–∏) ---
        function boardToFen() {
            let fen = '';
            for (let r = 0; r < 8; r++) {
                let empty = 0;
                for (let c = 0; c < 8; c++) {
                    const piece = board[r][c];
                    if (!piece) {
                        empty++;
                    } else {
                        if (empty > 0) {
                            fen += empty;
                            empty = 0;
                        }
                        let pChar = piece.type;
                        if (piece.color === 'w') pChar = pChar.toUpperCase();
                        fen += pChar;
                    }
                }
                if (empty > 0) fen += empty;
                if (r < 7) fen += '/';
            }
            return fen + ' ' + currentTurn + ' KQkq - 0 1'; // —É–ø—Ä–æ—â—ë–Ω–Ω–æ, –Ω–æ –¥–ª—è –ª–µ–≥–∞–ª—å–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ API –Ω–æ—Ä–º
        }

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ FEN (–±–∞–∑–æ–≤–æ) ---
        function initBoardFromFen(fen) {
            const parts = fen.split(' ');
            const position = parts[0];
            const rows = position.split('/');
            board = [];
            for (let r = 0; r < 8; r++) {
                const row = [];
                let col = 0;
                for (let char of rows[r]) {
                    if (isNaN(char)) {
                        const color = char === char.toUpperCase() ? 'w' : 'b';
                        const type = char.toLowerCase();
                        row[col] = { type, color };
                        col++;
                    } else {
                        let empty = parseInt(char, 10);
                        for (let i = 0; i < empty; i++) {
                            row[col] = null;
                            col++;
                        }
                    }
                }
                board.push(row);
            }
            currentTurn = (parts[1] || 'w');
            selectedSquare = null;
            // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–µ—à –ª–µ–≥–∞–ª—å–Ω—ã—Ö —Ö–æ–¥–æ–≤ ‚Äî –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—à–µ–Ω –∑–∞–Ω–æ–≤–æ
            legalMovesCache.clear();
        }

        // --- –ü—Ä–∏–º–µ–Ω–∏—Ç—å UCI —Ö–æ–¥ –∫ –¥–æ—Å–∫–µ (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏, —Ç–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞) ---
        function applyUciMove(uci) {
            if (!uci || uci.length < 4) return false;
            const fromCol = uci.charCodeAt(0) - 97;
            const fromRow = 8 - parseInt(uci[1]);
            const toCol = uci.charCodeAt(2) - 97;
            const toRow = 8 - parseInt(uci[3]);

            if (fromRow < 0 || fromRow > 7 || fromCol < 0 || fromCol > 7 || toRow < 0 || toRow > 7 || toCol < 0 || toCol > 7) return false;
            const piece = board[fromRow][fromCol];
            if (!piece) return false;

            // –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
            board[toRow][toCol] = piece;
            board[fromRow][fromCol] = null;

            // –ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—à–∫–∏ (–≤—Å–µ–≥–¥–∞ –≤ —Ñ–µ—Ä–∑—è –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã)
            if (piece.type === 'p' && (toRow === 0 || toRow === 7)) {
                board[toRow][toCol] = { type: 'q', color: piece.color };
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ lastMove
            lastMove = { from: { row: fromRow, col: fromCol }, to: { row: toRow, col: toCol } };
            return true;
        }

        // --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π –ª–µ–≥–∞–ª—å–Ω—ã—Ö —Ö–æ–¥–æ–≤ –∏–∑ –∫–µ—à–∞ ---
        function renderBoard() {
            boardEl.innerHTML = '';
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const row = flipped ? 7 - r : r;
                    const col = flipped ? 7 - c : c;
                    const piece = board[row][col];
                    const isLight = (row + col) % 2 === 0;

                    const squareDiv = document.createElement('div');
                    squareDiv.className = `square ${isLight ? 'light' : 'dark'}`;
                    squareDiv.dataset.row = row;
                    squareDiv.dataset.col = col;

                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
                    if (selectedSquare && selectedSquare.row === row && selectedSquare.col === col) {
                        squareDiv.classList.add('selected');
                    }

                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ö–æ–¥–∞
                    if (lastMove) {
                        if ((lastMove.from.row === row && lastMove.from.col === col) ||
                            (lastMove.to.row === row && lastMove.to.col === col)) {
                            squareDiv.classList.add('last-move');
                        }
                    }

                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ñ–∏–≥—É—Ä—ã
                    if (selectedSquare && !(selectedSquare.row === row && selectedSquare.col === col)) {
                        const fromUci = String.fromCharCode(97 + selectedSquare.col) + (8 - selectedSquare.row);
                        const toUci = String.fromCharCode(97 + col) + (8 - row);
                        const moveUci = fromUci + toUci;
                        if (legalMovesCache.has(moveUci)) {
                            // –ü—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ —Ñ–∏–≥—É—Ä–∞ –≤ —Ü–µ–ª–µ–≤–æ–π –∫–ª–µ—Ç–∫–µ (–≤–∑—è—Ç–∏–µ)
                            if (board[row][col] !== null) {
                                squareDiv.classList.add('possible-capture');
                            } else {
                                squareDiv.classList.add('possible-move');
                            }
                        }
                    }

                    // –§–∏–≥—É—Ä–∞
                    if (piece) {
                        squareDiv.textContent = getPieceSymbol(piece);
                    }

                    squareDiv.addEventListener('click', onSquareClick);
                    boardEl.appendChild(squareDiv);
                }
            }

            // –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—á–µ—Ä–µ–¥–∏
            pieceIndicator.innerHTML = currentTurn === 'w' ? '‚ôî –•–æ–¥ –±–µ–ª—ã—Ö' : '‚ôö –•–æ–¥ —á—ë—Ä–Ω—ã—Ö';
        }

        // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ ---
        function onSquareClick(e) {
            const row = parseInt(e.currentTarget.dataset.row);
            const col = parseInt(e.currentTarget.dataset.col);
            const piece = board[row][col];

            // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ
            if (selectedSquare === null) {
                if (piece && piece.color === currentTurn) {
                    selectedSquare = { row, col };
                    renderBoard();
                }
                return;
            }

            // –£–∂–µ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–∞—è —Ñ–∏–≥—É—Ä–∞
            const from = selectedSquare;

            // –ö–ª–∏–∫ –Ω–∞ —Ç—É –∂–µ –∫–ª–µ—Ç–∫—É ‚Üí —Å–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            if (from.row === row && from.col === col) {
                selectedSquare = null;
                renderBoard();
                return;
            }

            // –ö–ª–∏–∫ –Ω–∞ —Å–≤–æ—é —Ñ–∏–≥—É—Ä—É –¥—Ä—É–≥—É—é ‚Üí —Å–º–µ–Ω–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            if (piece && piece.color === currentTurn) {
                selectedSquare = { row, col };
                renderBoard();
                return;
            }

            // –ü–æ–ø—ã—Ç–∫–∞ —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥
            const fromUci = String.fromCharCode(97 + from.col) + (8 - from.row);
            const toUci = String.fromCharCode(97 + col) + (8 - row);
            const moveUci = fromUci + toUci;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∫–µ—à—É –ª–µ–≥–∞–ª—å–Ω—ã—Ö —Ö–æ–¥–æ–≤
            if (legalMovesCache.has(moveUci)) {
                // –í—ã–ø–æ–ª–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                applyUciMove(moveUci);
                // –ú–µ–Ω—è–µ–º –æ—á–µ—Ä–µ–¥—å
                currentTurn = (currentTurn === 'w' ? 'b' : 'w');
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é (FEN –¥–æ —Ö–æ–¥–∞)
                const fenBefore = boardToFen(); // –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã? –Ω–µ—Ç, –Ω–∞–¥–æ –¥–æ —Å–º–µ–Ω—ã
                // –Ω–æ –Ω–∞–º –Ω—É–∂–Ω–∞ –ø–æ–∑–∏—Ü–∏—è –î–û —Ö–æ–¥–∞, –∏—Å–ø—Ä–∞–≤–∏–º:
                // –ø—Ä–æ—â–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º:
                // –Ω–æ –º—ã —É–∂–µ –ø–æ–º–µ–Ω—è–ª–∏ –¥–æ—Å–∫—É, —Å–æ—Ö—Ä–∞–Ω–∏–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ñ–µ–Ω –∑–∞—Ä–∞–Ω–µ–µ
                // –ø–µ—Ä–µ–¥–µ–ª–∞–µ–º: —Å–æ—Ö—Ä–∞–Ω–∏–º –¥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
                const prevFen = boardToFen(); // —Ç—É—Ç –µ—â—ë —Å—Ç–∞—Ä—ã–π currentTurn
                // –Ω–æ –º—ã —É–∂–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏ —Ö–æ–¥? –¥–∞, applyUciMove –∏–∑–º–µ–Ω–∏–ª –¥–æ—Å–∫—É.
                // –°–æ—Ö—Ä–∞–Ω–∏–º prevFen –≤—Ä—É—á–Ω—É—é –¥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫.
                // –õ—É—á—à–µ: —Å–æ—Ö—Ä–∞–Ω–∏–º –¥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
                // –î–ª—è —ç—Ç–æ–≥–æ –Ω–∞–¥–æ –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å: —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º prevFen, –ø–æ—Ç–æ–º –ø—Ä–∏–º–µ–Ω—è–µ–º.
                // –ù–æ –∫–æ–¥ —É–∂–µ –ø—Ä–∏–º–µ–Ω–∏–ª. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥:
                // –Ø —Å–µ–π—á–∞—Å –±—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ–ø–∏—à—É —ç—Ç—É —á–∞—Å—Ç—å:
                // --- –≤—Å—Ç–∞–≤–∏–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –±–ª–æ–∫:
                // –°–¥–µ–ª–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
                selectedSquare = null;
                // –ù–æ —É–∂–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏ —Ö–æ–¥, –ø–æ—ç—Ç–æ–º—É history –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è.
                // –≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ –∏—Å–ø—Ä–∞–≤–ª—é: —Å–æ–∑–¥–∞–¥–∏–º —Ñ—É–Ω–∫—Ü–∏—é makeLegalMove
                makeLegalMove(moveUci); // –≤—ã–∑–æ–≤–µ–º –∑–∞–Ω–æ–≤–æ, –Ω–æ –Ω—É–∂–Ω–æ –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω–æ–≥–æ —Ö–æ–¥–∞
                // –ü–æ—ç—Ç–æ–º—É —è –∑–∞–º–µ–Ω—é –ª–æ–≥–∏–∫—É –∫–ª–∏–∫–∞ –Ω–∞ –≤—ã–∑–æ–≤ makeLegalMove(moveUci)
                // –°–µ–π—á–∞—Å –ø–µ—Ä–µ–ø–∏—à—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫:
                // –ü—Ä–æ—Å—Ç–æ –∑–∞–º–µ–Ω–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–∞ –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏, –∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–±–µ—Ä—É.
                // –í—ã–Ω–µ—Å—É –ª–æ–≥–∏–∫—É –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é.
                initiateMove(moveUci);
            } else {
                alert('–ù–µ–≤–æ–∑–º–æ–∂–Ω—ã–π —Ö–æ–¥ (–Ω–µ –≤ —Å–ø–∏—Å–∫–µ –ª–µ–≥–∞–ª—å–Ω—ã—Ö)');
                selectedSquare = null;
                renderBoard();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –ª–µ–≥–∞–ª—å–Ω–æ–≥–æ —Ö–æ–¥–∞ (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏—Å—Ç–æ—Ä–∏–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∞–Ω–∞–ª–∏–∑–∞)
        function initiateMove(moveUci) {
            if (!legalMovesCache.has(moveUci)) return;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º FEN –ø–µ—Ä–µ–¥ —Ö–æ–¥–æ–º
            const fenBefore = boardToFen();
            gameHistory.push(fenBefore);

            // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ö–æ–¥
            applyUciMove(moveUci);
            // –°–º–µ–Ω–∏—Ç—å –æ—á–µ—Ä–µ–¥—å
            currentTurn = (currentTurn === 'w' ? 'b' : 'w');

            // –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏ –∫–µ—à (—É—Å—Ç–∞—Ä–µ–ª)
            selectedSquare = null;
            legalMovesCache.clear();

            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –∏ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
            renderBoard();
            fetchFullAnalysis();
        }

        // --- –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ª–µ–≥–∞–ª—å–Ω—ã—Ö —Ö–æ–¥–æ–≤ –∏ –∞–Ω–∞–ª–∏–∑–∞ —Å Lichess (–º–Ω–æ–≥–æ–≤–∞—Ä–∏–∞–Ω—Ç–Ω—ã–π, –≥–ª—É–±–æ–∫–∏–π) ---
        function fetchFullAnalysis() {
            const fen = boardToFen();
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ 10 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. multiPv=10 –¥–∞—Å—Ç –º–Ω–æ–≥–æ –ª–µ–≥–∞–ª—å–Ω—ã—Ö —Ö–æ–¥–æ–≤ (–æ–±—ã—á–Ω–æ –ø–æ—á—Ç–∏ –≤—Å–µ)
            // –¢–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≥–ª—É–±–∏–Ω—ã: https://lichess.org/api#tag/Cloud-Eval/operation/apiCloudEval
            const url = `https://lichess.org/api/cloud-eval?fen=${encodeURIComponent(fen)}&multiPv=10&variant=standard`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (!data || !data.pvs || data.pvs.length === 0) {
                        // –ü–æ–∑–∏—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –º–∞—Ç–æ–≤–æ–π –∏–ª–∏ –Ω–µ—Ç –æ–±–ª–∞—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                        evalDisplay.innerText = '‚Äî';
                        bestMovesList.innerHTML = '<div class="move-row"><span>–ù–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</span><span></span></div>';
                        evalBar.style.width = '50%';
                        legalMovesCache.clear();
                        renderBoard();
                        return;
                    }

                    currentEvalData = data;

                    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ª–µ–≥–∞–ª—å–Ω—ã–µ —Ö–æ–¥—ã –∏–∑ –≤—Å–µ—Ö PV (–ø–µ—Ä–≤—ã–π —Ö–æ–¥ –∫–∞–∂–¥–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞)
                    const movesSet = new Set();
                    data.pvs.forEach(pv => {
                        if (pv.moves) {
                            const firstMove = pv.moves.split(' ')[0];
                            if (firstMove && firstMove.length >= 4) movesSet.add(firstMove);
                        }
                    });

                    legalMovesCache = movesSet;

                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ü–µ–Ω–∫—É
                    const pv0 = data.pvs[0];
                    let cp = pv0.cp;
                    let mate = pv0.mate;
                    let evalText = '';
                    if (mate !== undefined) {
                        evalText = `#${mate}`;
                    } else if (cp !== undefined) {
                        evalText = (cp / 100).toFixed(2);
                    } else {
                        evalText = '0.00';
                    }
                    evalDisplay.innerText = evalText;

                    // Bar
                    let barWidth = 50;
                    if (mate !== undefined) {
                        barWidth = mate > 0 ? 100 : 0;
                    } else if (cp !== undefined) {
                        let evalNorm = Math.max(-5, Math.min(5, cp / 100));
                        barWidth = 50 + evalNorm * 10;
                        if (barWidth < 0) barWidth = 0;
                        if (barWidth > 100) barWidth = 100;
                    }
                    evalBar.style.width = barWidth + '%';

                    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ª—É—á—à–∏—Ö —Ö–æ–¥–æ–≤ (–¥–æ 5)
                    let htmlStr = '';
                    data.pvs.slice(0, 5).forEach((pv, idx) => {
                        const firstUci = pv.moves ? pv.moves.split(' ')[0] : '';
                        let moveStr = firstUci;
                        if (moveStr.length >= 4) {
                            moveStr = moveStr.slice(0,2) + ' ‚Üí ' + moveStr.slice(2,4);
                        }
                        let score = '';
                        if (pv.mate) score = '#' + pv.mate;
                        else if (pv.cp) score = (pv.cp/100).toFixed(2);
                        htmlStr += `<div class="move-row"><span>${moveStr}</span><span>${score}</span></div>`;
                    });
                    bestMovesList.innerHTML = htmlStr;

                    renderBoard(); // –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫—É –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤
                })
                .catch(err => {
                    console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–∞', err);
                    bestMovesList.innerHTML = '<div class="move-row"><span>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</span><span></span></div>';
                });
        }

        // --- –ù–æ–≤–∞—è –∏–≥—Ä–∞ ---
        function newGame() {
            initBoardFromFen(startFen);
            lastMove = null;
            gameHistory = [];
            selectedSquare = null;
            legalMovesCache.clear();
            renderBoard();
            fetchFullAnalysis();
        }

        // --- –û—Ç–º–µ–Ω–∞ —Ö–æ–¥–∞ ---
        function undoMove() {
            if (gameHistory.length === 0) {
                alert('–ù–µ—Ç —Ö–æ–¥–æ–≤ –¥–ª—è –æ—Ç–º–µ–Ω—ã');
                return;
            }
            const prevFen = gameHistory.pop();
            initBoardFromFen(prevFen);
            lastMove = null; // –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏, –Ω–æ —É–ø—Ä–æ—Å—Ç–∏–º
            selectedSquare = null;
            legalMovesCache.clear();
            renderBoard();
            fetchFullAnalysis();
        }

        // --- –ü–µ—Ä–µ–≤–æ—Ä–æ—Ç ---
        function flipBoard() {
            flipped = !flipped;
            renderBoard();
        }

        // --- –°—Ç–∞—Ä—Ç ---
        initBoardFromFen(startFen);
        renderBoard();
        fetchFullAnalysis();

        // –ö–Ω–æ–ø–∫–∏
        document.getElementById('newGameBtn').addEventListener('click', newGame);
        document.getElementById('flipBtn').addEventListener('click', flipBoard);
        document.getElementById('undoBtn').addEventListener('click', undoMove);
    })();
</script>
</body>
</html>
