<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∞—Ö–º–∞—Ç—ã —Å Lichess API ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ö–æ–¥–æ–≤ —á–µ—Ä–µ–∑ –æ–±–ª–∞–∫–æ</title>
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
        }
        body {
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
            background: linear-gradient(145deg, #1e3a2f 0%, #132822 100%);
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            max-width: 1300px;
            width: 100%;
            background: rgba(10, 25, 20, 0.85);
            backdrop-filter: blur(4px);
            border-radius: 48px;
            padding: 30px;
            box-shadow: 0 30px 50px rgba(0, 0, 0, 0.8), inset 0 1px 3px rgba(255, 215, 0, 0.3);
            border: 1px solid #c9a96b;
        }
        h1 {
            text-align: center;
            margin: 0 0 20px 0;
            font-weight: 400;
            color: #f5e7c8;
            letter-spacing: 2px;
            text-shadow: 2px 2px 0 #2a4a3a;
            font-size: 2.5rem;
        }
        h1 span {
            color: #ffd966;
            font-weight: 600;
        }
        .board-section {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
        }
        .board-wrapper {
            background: #2d4a3a;
            padding: 20px 20px 25px 20px;
            border-radius: 42px;
            box-shadow: inset 0 -6px 0 #1b3226, 0 25px 35px rgba(0, 0, 0, 0.7);
            border: 1px solid #e3b87c;
            position: relative;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(8, 75px);
            grid-template-rows: repeat(8, 75px);
            gap: 0;
            border: 5px solid #5f4a2e;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 0 3px #a47e54;
            position: relative;
        }
        .square {
            width: 75px;
            height: 75px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 52px;
            cursor: pointer;
            transition: 0.08s ease;
            text-shadow: 2px 4px 5px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        .square.light {
            background-color: #edd6b0;
        }
        .square.dark {
            background-color: #b5885a;
        }
        .square.selected {
            background-color: #b0d9ff !important;
            box-shadow: inset 0 0 0 4px #004b8f;
        }
        .square.possible-move {
            position: relative;
        }
        .square.possible-move::after {
            content: "";
            position: absolute;
            width: 24px;
            height: 24px;
            background: rgba(0, 120, 0, 0.5);
            border-radius: 50%;
            pointer-events: none;
            border: 2px solid #a0d6a0;
            box-shadow: 0 0 10px #00aa00;
            z-index: 5;
        }
        .square.possible-capture::after {
            content: "";
            position: absolute;
            width: 60px;
            height: 60px;
            border: 5px solid rgba(180, 0, 0, 0.6);
            border-radius: 50%;
            background: rgba(255, 0, 0, 0.15);
            pointer-events: none;
            box-shadow: 0 0 15px #ff4d4d;
            z-index: 5;
        }
        .square.last-move {
            background-color: #c7e5b0 !important;
            box-shadow: inset 0 0 0 3px #2f7d2f;
        }
        .square.dragging {
            opacity: 0.6;
            transform: scale(1.05);
            z-index: 100;
        }
        .coord {
            font-size: 16px;
            color: #efe2c6;
            text-align: center;
            margin-top: 12px;
            font-weight: 600;
            letter-spacing: 4px;
        }
        .info-panel {
            flex: 1;
            min-width: 300px;
            background: #1c3d31;
            border-radius: 38px;
            padding: 25px;
            box-shadow: inset 0 -4px 0 #0e2820, 0 20px 30px rgba(0, 0, 0, 0.6);
            border: 1px solid #9eba8b;
            color: #f2f0d7;
        }
        .piece-indicator {
            font-size: 32px;
            background: #14362b;
            padding: 12px 20px;
            border-radius: 50px;
            text-align: center;
            margin: 5px 0 20px;
            border: 2px solid #e3b87c;
            box-shadow: inset 0 2px 5px #0b1f18;
            color: #ffeca2;
        }
        .eval-bar-container {
            background: #142e24;
            border-radius: 60px;
            height: 35px;
            width: 100%;
            margin: 20px 0;
            border: 3px solid #768e7a;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 3px 8px #091510;
        }
        .eval-fill {
            height: 100%;
            width: 50%;
            background: linear-gradient(90deg, #3b6e5b, #c9a96b);
            transition: width 0.3s;
        }
        .eval-text {
            font-size: 32px;
            font-weight: 800;
            text-align: center;
            margin: 15px 0;
            background: #16352a;
            padding: 15px;
            border-radius: 60px;
            border: 2px solid #edd19b;
            color: #ffeca2;
            letter-spacing: 2px;
            font-family: monospace;
        }
        .best-moves {
            background: #1a3f32;
            border-radius: 32px;
            padding: 18px;
            margin: 20px 0;
            border: 1px solid #bcaa7a;
        }
        .best-moves h3 {
            margin: 0 0 15px 0;
            color: #fad980;
            font-weight: 400;
            border-bottom: 3px solid #6e947a;
            padding-bottom: 10px;
            font-size: 22px;
        }
        .move-row {
            display: flex;
            justify-content: space-between;
            background: #124130;
            padding: 14px 22px;
            margin: 10px 0;
            border-radius: 50px;
            font-size: 22px;
            font-weight: 600;
            border: 2px solid #6f8b72;
            color: #ffeab3;
        }
        .move-row span:first-child {
            color: #cce3d4;
            font-weight: 400;
        }
        .buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 30px;
        }
        button {
            background: #2f604a;
            border: none;
            padding: 16px 22px;
            border-radius: 60px;
            font-size: 20px;
            font-weight: 600;
            color: #fbf3d7;
            cursor: pointer;
            flex: 1 1 auto;
            box-shadow: 0 8px 0 #1a3d2f, 0 6px 18px black;
            transition: 0.07s linear;
            border: 1px solid #c6ad78;
        }
        button:active {
            transform: translateY(6px);
            box-shadow: 0 2px 0 #1a3d2f;
        }
        button:disabled {
            opacity: 0.4;
            transform: none;
            pointer-events: none;
        }
        .reset-btn {
            background: #735f40;
            box-shadow: 0 8px 0 #4e3e28;
            border-color: #e3b06c;
        }
        .footer {
            text-align: center;
            color: #b3cfbf;
            margin-top: 25px;
            font-size: 16px;
            font-weight: 300;
        }
        .dragging-piece {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            font-size: 52px;
            text-shadow: 2px 4px 8px black;
            transform: translate(-50%, -50%);
        }
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>‚ôõ <span>Lichess</span> –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö–æ–¥–æ–≤ —á–µ—Ä–µ–∑ API ‚ôö</h1>
    <div class="board-section">
        <div class="board-wrapper">
            <div class="board" id="chessboard"></div>
            <div class="coord">a  b  c  d  e  f  g  h</div>
        </div>
        <div class="info-panel">
            <div class="piece-indicator" id="pieceIndicator">‚ö™ –•–æ–¥ –±–µ–ª—ã—Ö</div>
            <div class="eval-text" id="evalDisplay">0.00</div>
            <div class="eval-bar-container">
                <div class="eval-fill" id="evalBar" style="width: 50%;"></div>
            </div>

            <div class="best-moves">
                <h3>üîç –õ—É—á—à–∏–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è (Lichess Cloud)</h3>
                <div id="bestMovesList">
                    <div class="move-row"><span>–ó–∞–≥—Ä—É–∑–∫–∞...</span><span></span></div>
                </div>
            </div>

            <div class="buttons">
                <button id="newGameBtn" class="reset-btn">‚ôî –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
                <button id="flipBtn">üîÑ –ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å</button>
                <button id="undoBtn">‚Ü© –û—Ç–º–µ–Ω–∞</button>
            </div>
            <p style="margin: 20px 0 5px; font-size: 18px; text-align: center;">‚¨§ –∑–µ–ª—ë–Ω—ã–π ‚Äî —Ö–æ–¥, üî¥ –∫—Ä–∞—Å–Ω—ã–π ‚Äî –≤–∑—è—Ç–∏–µ</p>
            <p style="margin: 5px 0 0; font-size: 16px; text-align: center;">‚ú• –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π –∏–ª–∏ –∫–ª–∏–∫–∞–π ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Lichess</p>
        </div>
    </div>
    <div class="footer">–í—Å–µ —Ö–æ–¥—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –æ–±–ª–∞—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ Lichess ¬∑ 100% –ª–µ–≥–∞–ª—å–Ω–æ—Å—Ç—å</div>
</div>

<script>
    (function() {
        // --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ---
        const startFen = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';
        
        // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ ---
        let board = [];
        let currentTurn = 'w';
        let selectedSquare = null;
        let lastMove = null;
        let flipped = false;
        let gameHistory = [];
        let legalMoves = new Map(); // –∫–∞—Ä—Ç–∞ "from_key" -> –º–∞—Å—Å–∏–≤ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö toUCI
        let isLoading = false;
        
        // --- Drag and drop ---
        let isDragging = false;
        let dragStartSquare = null;
        let dragElement = null;
        
        // --- DOM —ç–ª–µ–º–µ–Ω—Ç—ã ---
        const boardEl = document.getElementById('chessboard');
        const evalDisplay = document.getElementById('evalDisplay');
        const evalBar = document.getElementById('evalBar');
        const bestMovesList = document.getElementById('bestMovesList');
        const pieceIndicator = document.getElementById('pieceIndicator');
        
        // --- –£—Ç–∏–ª–∏—Ç—ã ---
        function getPieceSymbol(piece) {
            if (!piece) return '';
            const symbols = {
                k: '‚ôö', q: '‚ôõ', r: '‚ôú', b: '‚ôù', n: '‚ôû', p: '‚ôü',
                K: '‚ôî', Q: '‚ôï', R: '‚ôñ', B: '‚ôó', N: '‚ôò', P: '‚ôô'
            };
            let key = piece.type;
            if (piece.color === 'w') key = key.toUpperCase();
            return symbols[key] || '';
        }
        
        function boardToFen() {
            let fen = '';
            for (let r = 0; r < 8; r++) {
                let empty = 0;
                for (let c = 0; c < 8; c++) {
                    const piece = board[r][c];
                    if (!piece) {
                        empty++;
                    } else {
                        if (empty > 0) {
                            fen += empty;
                            empty = 0;
                        }
                        let pChar = piece.type;
                        if (piece.color === 'w') pChar = pChar.toUpperCase();
                        fen += pChar;
                    }
                }
                if (empty > 0) fen += empty;
                if (r < 7) fen += '/';
            }
            return fen + ' ' + currentTurn + ' KQkq - 0 1';
        }
        
        function initBoardFromFen(fen) {
            const parts = fen.split(' ');
            const position = parts[0];
            const rows = position.split('/');
            board = [];
            for (let r = 0; r < 8; r++) {
                const row = [];
                let col = 0;
                for (let char of rows[r]) {
                    if (isNaN(char)) {
                        const color = char === char.toUpperCase() ? 'w' : 'b';
                        const type = char.toLowerCase();
                        row[col] = { type, color };
                        col++;
                    } else {
                        let empty = parseInt(char, 10);
                        for (let i = 0; i < empty; i++) {
                            row[col] = null;
                            col++;
                        }
                    }
                }
                board.push(row);
            }
            currentTurn = (parts[1] || 'w');
            selectedSquare = null;
        }
        
        function applyUciMove(uci) {
            if (!uci || uci.length < 4) return false;
            const fromCol = uci.charCodeAt(0) - 97;
            const fromRow = 8 - parseInt(uci[1]);
            const toCol = uci.charCodeAt(2) - 97;
            const toRow = 8 - parseInt(uci[3]);
            
            if (fromRow < 0 || fromRow > 7 || fromCol < 0 || fromCol > 7 || toRow < 0 || toRow > 7 || toCol < 0 || toCol > 7) return false;
            const piece = board[fromRow][fromCol];
            if (!piece) return false;
            
            board[toRow][toCol] = piece;
            board[fromRow][fromCol] = null;
            
            // –ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—à–∫–∏
            if (piece.type === 'p' && (toRow === 0 || toRow === 7)) {
                board[toRow][toCol] = { type: 'q', color: piece.color };
            }
            
            lastMove = { from: { row: fromRow, col: fromCol }, to: { row: toRow, col: toCol } };
            return true;
        }
        
        // --- –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–µ–≥–∞–ª—å–Ω—ã—Ö —Ö–æ–¥–æ–≤ —á–µ—Ä–µ–∑ Lichess API ---
        async function fetchLegalMoves() {
            if (isLoading) return;
            
            isLoading = true;
            const fen = boardToFen();
            const url = `https://lichess.org/api/cloud-eval?fen=${encodeURIComponent(fen)}&multiPv=10&variant=standard`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data || !data.pvs || data.pvs.length === 0) {
                    legalMoves.clear();
                    updateEvalDisplay(null);
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ü–µ–Ω–∫—É
                updateEvalDisplay(data.pvs[0]);
                
                // –°—Ç—Ä–æ–∏–º –∫–∞—Ä—Ç—É –ª–µ–≥–∞–ª—å–Ω—ã—Ö —Ö–æ–¥–æ–≤
                const movesMap = new Map();
                data.pvs.forEach(pv => {
                    if (pv.moves) {
                        const firstMove = pv.moves.split(' ')[0];
                        if (firstMove && firstMove.length >= 4) {
                            const from = firstMove.substring(0, 2);
                            const to = firstMove.substring(2, 4);
                            if (!movesMap.has(from)) {
                                movesMap.set(from, []);
                            }
                            movesMap.get(from).push(to);
                        }
                    }
                });
                
                legalMoves = movesMap;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ª—É—á—à–∏—Ö —Ö–æ–¥–æ–≤
                updateBestMovesList(data.pvs);
                
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–æ—Å–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
                renderBoard();
                
            } catch (error) {
                console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–µ–≥–∞–ª—å–Ω—ã—Ö —Ö–æ–¥–æ–≤:', error);
                legalMoves.clear();
                bestMovesList.innerHTML = '<div class="move-row"><span>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</span><span></span></div>';
            } finally {
                isLoading = false;
            }
        }
        
        function updateEvalDisplay(pv) {
            if (!pv) {
                evalDisplay.innerText = '‚Äî';
                evalBar.style.width = '50%';
                return;
            }
            
            let cp = pv.cp;
            let mate = pv.mate;
            let evalText = '';
            
            if (mate !== undefined) {
                evalText = `#${mate}`;
            } else if (cp !== undefined) {
                evalText = (cp / 100).toFixed(2);
            } else {
                evalText = '0.00';
            }
            evalDisplay.innerText = evalText;
            
            let barWidth = 50;
            if (mate !== undefined) {
                barWidth = mate > 0 ? 100 : 0;
            } else if (cp !== undefined) {
                let evalNorm = Math.max(-5, Math.min(5, cp / 100));
                barWidth = 50 + evalNorm * 10;
                if (barWidth < 0) barWidth = 0;
                if (barWidth > 100) barWidth = 100;
            }
            evalBar.style.width = barWidth + '%';
        }
        
        function updateBestMovesList(pvs) {
            let htmlStr = '';
            pvs.slice(0, 5).forEach((pv, idx) => {
                const firstUci = pv.moves ? pv.moves.split(' ')[0] : '';
                let moveStr = firstUci;
                if (moveStr.length >= 4) {
                    moveStr = moveStr.slice(0,2) + ' ‚Üí ' + moveStr.slice(2,4);
                }
                let score = '';
                if (pv.mate) score = '#' + pv.mate;
                else if (pv.cp) score = (pv.cp/100).toFixed(2);
                htmlStr += `<div class="move-row"><span>${moveStr}</span><span>${score}</span></div>`;
            });
            bestMovesList.innerHTML = htmlStr;
        }
        
        // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–µ–≥–∞–ª—å–Ω–æ—Å—Ç–∏ —Ö–æ–¥–∞ ---
        function isLegalMove(fromRow, fromCol, toRow, toCol) {
            const fromUci = String.fromCharCode(97 + fromCol) + (8 - fromRow);
            const toUci = String.fromCharCode(97 + toCol) + (8 - toRow);
            
            if (legalMoves.has(fromUci)) {
                return legalMoves.get(fromUci).includes(toUci);
            }
            return false;
        }
        
        // --- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ö–æ–¥–∞ ---
        async function makeMove(fromRow, fromCol, toRow, toCol) {
            if (!isLegalMove(fromRow, fromCol, toRow, toCol)) {
                return false;
            }
            
            const fromUci = String.fromCharCode(97 + fromCol) + (8 - fromRow);
            const toUci = String.fromCharCode(97 + toCol) + (8 - toRow);
            const moveUci = fromUci + toUci;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
            const fenBefore = boardToFen();
            gameHistory.push(fenBefore);
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ö–æ–¥
            applyUciMove(moveUci);
            currentTurn = currentTurn === 'w' ? 'b' : 'w';
            selectedSquare = null;
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ –ª–µ–≥–∞–ª—å–Ω—ã–µ —Ö–æ–¥—ã
            renderBoard();
            await fetchLegalMoves();
            
            return true;
        }
        
        // --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–æ—Å–∫–∏ ---
        function renderBoard() {
            boardEl.innerHTML = '';
            
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const row = flipped ? 7 - r : r;
                    const col = flipped ? 7 - c : c;
                    const piece = board[row][col];
                    const isLight = (row + col) % 2 === 0;
                    
                    const squareDiv = document.createElement('div');
                    squareDiv.className = `square ${isLight ? 'light' : 'dark'}`;
                    squareDiv.dataset.row = row;
                    squareDiv.dataset.col = col;
                    
                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
                    if (selectedSquare && selectedSquare.row === row && selectedSquare.col === col) {
                        squareDiv.classList.add('selected');
                    }
                    
                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ö–æ–¥–∞
                    if (lastMove) {
                        if ((lastMove.from.row === row && lastMove.from.col === col) ||
                            (lastMove.to.row === row && lastMove.to.col === col)) {
                            squareDiv.classList.add('last-move');
                        }
                    }
                    
                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ñ–∏–≥—É—Ä—ã
                    if (selectedSquare && !(selectedSquare.row === row && selectedSquare.col === col)) {
                        const fromUci = String.fromCharCode(97 + selectedSquare.col) + (8 - selectedSquare.row);
                        const toUci = String.fromCharCode(97 + col) + (8 - row);
                        
                        if (legalMoves.has(fromUci) && legalMoves.get(fromUci).includes(toUci)) {
                            if (board[row][col] !== null) {
                                squareDiv.classList.add('possible-capture');
                            } else {
                                squareDiv.classList.add('possible-move');
                            }
                        }
                    }
                    
                    if (piece) {
                        squareDiv.textContent = getPieceSymbol(piece);
                    }
                    
                    // –°–æ–±—ã—Ç–∏—è
                    squareDiv.addEventListener('mousedown', onMouseDown);
                    squareDiv.addEventListener('click', onClick);
                    
                    boardEl.appendChild(squareDiv);
                }
            }
            
            pieceIndicator.innerHTML = currentTurn === 'w' ? '‚ôî –•–æ–¥ –±–µ–ª—ã—Ö' : '‚ôö –•–æ–¥ —á—ë—Ä–Ω—ã—Ö';
        }
        
        // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ ---
        async function onClick(e) {
            if (isLoading) return;
            
            const row = parseInt(e.currentTarget.dataset.row);
            const col = parseInt(e.currentTarget.dataset.col);
            const piece = board[row][col];
            
            // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ
            if (selectedSquare === null) {
                if (piece && piece.color === currentTurn) {
                    selectedSquare = { row, col };
                    renderBoard();
                }
                return;
            }
            
            // –£–∂–µ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–∞—è —Ñ–∏–≥—É—Ä–∞
            const from = selectedSquare;
            
            // –ö–ª–∏–∫ –Ω–∞ —Ç—É –∂–µ –∫–ª–µ—Ç–∫—É
            if (from.row === row && from.col === col) {
                selectedSquare = null;
                renderBoard();
                return;
            }
            
            // –ü–æ–ø—ã—Ç–∫–∞ —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥
            const success = await makeMove(from.row, from.col, row, col);
            if (!success) {
                selectedSquare = null;
                renderBoard();
            }
        }
        
        // --- Drag and drop ---
        function onMouseDown(e) {
            if (isLoading) return;
            
            const square = e.currentTarget;
            const row = parseInt(square.dataset.row);
            const col = parseInt(square.dataset.col);
            const piece = board[row][col];
            
            if (!piece || piece.color !== currentTurn) return;
            
            e.preventDefault();
            isDragging = true;
            dragStartSquare = { row, col };
            
            // –°–æ–∑–¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            dragElement = document.createElement('div');
            dragElement.className = 'dragging-piece';
            dragElement.textContent = getPieceSymbol(piece);
            document.body.appendChild(dragElement);
            
            updateDragPosition(e.clientX, e.clientY);
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ñ–∏–≥—É—Ä—É
            selectedSquare = { row, col };
            renderBoard();
        }
        
        function onMouseMove(e) {
            if (!isDragging) return;
            e.preventDefault();
            updateDragPosition(e.clientX, e.clientY);
        }
        
        async function onMouseUp(e) {
            if (!isDragging || !dragStartSquare) return;
            
            const targetElement = document.elementFromPoint(e.clientX, e.clientY);
            const targetSquare = targetElement?.closest('.square');
            
            if (targetSquare && dragStartSquare) {
                const toRow = parseInt(targetSquare.dataset.row);
                const toCol = parseInt(targetSquare.dataset.col);
                const fromRow = dragStartSquare.row;
                const fromCol = dragStartSquare.col;
                
                await makeMove(fromRow, fromCol, toRow, toCol);
            }
            
            // –û—á–∏—Å—Ç–∫–∞
            if (dragElement) {
                dragElement.remove();
                dragElement = null;
            }
            isDragging = false;
            dragStartSquare = null;
            selectedSquare = null;
            
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            
            renderBoard();
        }
        
        function updateDragPosition(x, y) {
            if (dragElement) {
                dragElement.style.left = x + 'px';
                dragElement.style.top = y + 'px';
            }
        }
        
        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π ---
        function newGame() {
            initBoardFromFen(startFen);
            lastMove = null;
            gameHistory = [];
            selectedSquare = null;
            legalMoves.clear();
            renderBoard();
            fetchLegalMoves();
        }
        
        async function undoMove() {
            if (gameHistory.length === 0) {
                alert('–ù–µ—Ç —Ö–æ–¥–æ–≤ –¥–ª—è –æ—Ç–º–µ–Ω—ã');
                return;
            }
            const prevFen = gameHistory.pop();
            initBoardFromFen(prevFen);
            lastMove = null;
            selectedSquare = null;
            renderBoard();
            await fetchLegalMoves();
        }
        
        function flipBoard() {
            flipped = !flipped;
            renderBoard();
        }
        
        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        initBoardFromFen(startFen);
        renderBoard();
        fetchLegalMoves();
        
        // –ö–Ω–æ–ø–∫–∏
        document.getElementById('newGameBtn').addEventListener('click', newGame);
        document.getElementById('flipBtn').addEventListener('click', flipBoard);
        document.getElementById('undoBtn').addEventListener('click', undoMove);
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π drag
        document.addEventListener('dragstart', (e) => e.preventDefault());
    })();
</script>
</body>
</html>
