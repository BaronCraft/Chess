<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Шахматный анализ с Lichess API</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .main-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .board-container {
            flex: 2;
            min-width: 400px;
        }
        
        #board {
            width: 100%;
            aspect-ratio: 1/1;
            background-color: #f0d9b5;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .info-panel {
            flex: 1;
            min-width: 300px;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .section {
            background-color: white;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .fen-input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: monospace;
        }
        
        button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
            margin-bottom: 5px;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #218838;
        }
        
        button.secondary {
            background-color: #6c757d;
        }
        
        button.secondary:hover {
            background-color: #5a6268;
        }
        
        .analysis-output {
            background-color: #2d2d2d;
            color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .best-move {
            background-color: #007bff;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-weight: bold;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .eval-bar-container {
            background-color: #404040;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }
        
        .eval-bar {
            height: 100%;
            width: 50%;
            background: linear-gradient(90deg, #ffffff 0%, #808080 50%, #000000 100%);
            transition: width 0.3s;
        }
        
        .eval-text {
            position: absolute;
            top: 5px;
            left: 10px;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }
        
        .move-history {
            max-height: 150px;
            overflow-y: auto;
            font-family: monospace;
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>♜ Анализ шахматных позиций с Lichess API ♞</h1>
        
        <div class="main-panel">
            <div class="board-container">
                <div id="board"></div>
                
                <div class="controls">
                    <button onclick="resetBoard()">Начальная позиция</button>
                    <button onclick="clearBoard()">Очистить доску</button>
                    <button onclick="flipBoard()">Перевернуть доску</button>
                </div>
            </div>
            
            <div class="info-panel">
                <div class="section">
                    <h3>Позиция (FEN)</h3>
                    <input type="text" id="fenInput" class="fen-input" value="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1">
                    <button onclick="updateBoardFromFen()">Обновить позицию</button>
                    <button class="secondary" onclick="copyFen()">Копировать FEN</button>
                </div>
                
                <div class="section">
                    <h3>Анализ движка</h3>
                    <div class="controls">
                        <button onclick="analyzePosition()">Анализировать</button>
                        <button class="secondary" onclick="stopAnalysis()">Остановить</button>
                    </div>
                    
                    <div class="eval-bar-container">
                        <div class="eval-bar" id="evalBar" style="width: 50%"></div>
                        <span class="eval-text" id="evalText">0.00</span>
                    </div>
                    
                    <div id="bestMove" class="best-move">
                        Лучший ход: -
                    </div>
                    
                    <div id="analysis" class="analysis-output">
                        Нажмите "Анализировать" для получения оценки позиции
                    </div>
                </div>
                
                <div class="section">
                    <h3>История ходов</h3>
                    <div id="moveHistory" class="move-history">
                        <span id="historyList">Нет ходов</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <button onclick="undoMove()">Отменить ход</button>
                        <button onclick="clearHistory()">Очистить историю</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 20px; text-align: center; color: #6c757d; font-size: 12px;">
            Используется Lichess API для анализа. Данные обновляются в реальном времени.
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">

    <script>
        // Инициализация шахматной доски и движка
        let board = null;
        let game = new Chess();
        let currentAnalysis = null;
        let moveHistory = [];
        
        // Конфигурация доски
        const config = {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd,
            pieceTheme: 'https://lichess1.org/assets/_CwzD4C/images/piece/cburnett/{piece}.svg'
        };
        
        // Инициализация доски
        board = Chessboard('board', config);
        
        // Обновление FEN при изменении позиции
        $(window).resize(function() {
            board.resize();
        });
        
        function onDragStart(source, piece, position, orientation) {
            if (game.game_over()) return false;
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
        }
        
        function onDrop(source, target) {
            // Проверка на рокировку
            let move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });
            
            if (move === null) return 'snapback';
            
            // Обновление истории ходов
            updateHistory(move);
            
            // Обновление FEN поля
            document.getElementById('fenInput').value = game.fen();
            
            // Автоматический анализ после хода
            analyzePosition();
        }
        
        function onSnapEnd() {
            board.position(game.fen());
        }
        
        function updateBoardFromFen() {
            let fen = document.getElementById('fenInput').value;
            if (game.load(fen)) {
                board.position(fen);
                analyzePosition();
            } else {
                alert('Некорректный FEN формат');
            }
        }
        
        function resetBoard() {
            game.reset();
            board.position('start');
            document.getElementById('fenInput').value = game.fen();
            moveHistory = [];
            updateHistoryDisplay();
            analyzePosition();
        }
        
        function clearBoard() {
            game.clear();
            board.position(game.fen());
            document.getElementById('fenInput').value = game.fen();
            moveHistory = [];
            updateHistoryDisplay();
        }
        
        function flipBoard() {
            board.flip();
        }
        
        function copyFen() {
            navigator.clipboard.writeText(document.getElementById('fenInput').value);
            alert('FEN скопирован в буфер обмена');
        }
        
        function undoMove() {
            game.undo();
            board.position(game.fen());
            document.getElementById('fenInput').value = game.fen();
            moveHistory.pop();
            updateHistoryDisplay();
            analyzePosition();
        }
        
        function clearHistory() {
            moveHistory = [];
            updateHistoryDisplay();
        }
        
        function updateHistory(move) {
            moveHistory.push(move.san);
            updateHistoryDisplay();
        }
        
        function updateHistoryDisplay() {
            let historyElement = document.getElementById('historyList');
            if (moveHistory.length === 0) {
                historyElement.textContent = 'Нет ходов';
            } else {
                let historyText = '';
                for (let i = 0; i < moveHistory.length; i++) {
                    if (i % 2 === 0) {
                        historyText += (Math.floor(i/2) + 1) + '. ';
                    }
                    historyText += moveHistory[i] + ' ';
                }
                historyElement.textContent = historyText;
            }
        }
        
        function analyzePosition() {
            stopAnalysis();
            
            let fen = game.fen();
            let depth = 18; // Глубина анализа
            
            document.getElementById('analysis').innerHTML = 'Анализ позиции...\n';
            
            // Использование Lichess API для анализа
            $.ajax({
                url: 'https://lichess.org/api/cloud-eval',
                data: {
                    fen: fen,
                    multiPv: 3 // Показать 3 лучших варианта
                },
                success: function(data) {
                    displayAnalysis(data);
                },
                error: function(xhr, status, error) {
                    if (xhr.status === 404) {
                        document.getElementById('analysis').innerHTML = 'Позиция не найдена в облачной базе. Используется локальная оценка.\n';
                        localAnalysis();
                    } else {
                        document.getElementById('analysis').innerHTML = 'Ошибка при анализе. Используется локальная оценка.\n';
                        localAnalysis();
                    }
                }
            });
        }
        
        function localAnalysis() {
            // Простая локальная оценка позиции (материальный подсчет)
            let boardState = game.board();
            let evalScore = 0;
            let pieceValues = {
                'p': -1, 'n': -3, 'b': -3, 'r': -5, 'q': -9, 'k': 0,
                'P': 1, 'N': 3, 'B': 3, 'R': 5, 'Q': 9, 'K': 0
            };
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    let piece = boardState[row][col];
                    if (piece) {
                        evalScore += pieceValues[piece.type] * (piece.color === 'w' ? 1 : -1);
                    }
                }
            }
            
            // Приведение оценки к формату сантипешек
            let evalText = (evalScore > 0 ? '+' : '') + evalScore.toFixed(2);
            updateEvalBar(evalScore);
            
            let analysis = `Локальная оценка: ${evalText}\n`;
            analysis += `Глубина: поверхностная\n`;
            analysis += `Лучший ход: ${getRandomMove()}`;
            
            document.getElementById('analysis').innerHTML = analysis;
            document.getElementById('bestMove').innerHTML = `Лучший ход: ${getRandomMove()}`;
        }
        
        function getRandomMove() {
            let moves = game.moves();
            if (moves.length > 0) {
                return moves[Math.floor(Math.random() * moves.length)];
            }
            return 'нет доступных ходов';
        }
        
        function displayAnalysis(data) {
            if (data && data.pvs && data.pvs.length > 0) {
                let evalScore = data.pvs[0].cp / 100; // Конвертация в пешки
                updateEvalBar(evalScore);
                
                let analysis = `Оценка Lichess Cloud: ${data.pvs[0].cp > 0 ? '+' : ''}${(data.pvs[0].cp/100).toFixed(2)}\n`;
                analysis += `Глубина: ${data.depth}\n\n`;
                analysis += `Лучшие варианты:\n`;
                
                for (let i = 0; i < data.pvs.length; i++) {
                    analysis += `${i+1}. ${data.pvs[i].moves} (${data.pvs[i].cp > 0 ? '+' : ''}${(data.pvs[i].cp/100).toFixed(2)})\n`;
                }
                
                document.getElementById('analysis').innerHTML = analysis;
                
                // Показываем лучший ход
                let bestMove = data.pvs[0].moves.split(' ')[0];
                document.getElementById('bestMove').innerHTML = `Лучший ход: ${bestMove}`;
            } else {
                document.getElementById('analysis').innerHTML = 'Не удалось получить анализ';
            }
        }
        
        function updateEvalBar(score) {
            // Нормализация оценки для шкалы от -5 до +5
            let normalizedScore = Math.max(-5, Math.min(5, score));
            let percentage = (normalizedScore + 5) * 10; // Конвертация в проценты
            
            document.getElementById('evalBar').style.width = percentage + '%';
            document.getElementById('evalText').textContent = (score > 0 ? '+' : '') + score.toFixed(2);
            
            // Изменение цвета в зависимости от оценки
            if (score > 0) {
                document.getElementById('evalBar').style.background = 'linear-gradient(90deg, #ffffff, #000000)';
            } else {
                document.getElementById('evalBar').style.background = 'linear-gradient(90deg, #000000, #ffffff)';
            }
        }
        
        function stopAnalysis() {
            if (currentAnalysis) {
                currentAnalysis.abort();
                currentAnalysis = null;
            }
        }
        
        // Автоматический анализ при загрузке
        $(document).ready(function() {
            analyzePosition();
        });
    </script>
</body>
</html>
